#!/usr/bin/env swish

;;; Copyright 2018 Beckman Coulter, Inc.
;;;
;;; Permission is hereby granted, free of charge, to any person
;;; obtaining a copy of this software and associated documentation
;;; files (the "Software"), to deal in the Software without
;;; restriction, including without limitation the rights to use, copy,
;;; modify, merge, publish, distribute, sublicense, and/or sell copies
;;; of the Software, and to permit persons to whom the Software is
;;; furnished to do so, subject to the following conditions:
;;;
;;; The above copyright notice and this permission notice shall be
;;; included in all copies or substantial portions of the Software.
;;;
;;; THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
;;; EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
;;; MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
;;; NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
;;; HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
;;; WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
;;; OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
;;; DEALINGS IN THE SOFTWARE.

(define verbosity (make-parameter 0))

(define help-sections '(all details examples))

(define escape-hatch
  (cli-specs
   [explicit-source -- (list . "<source>") "source filename"]))

(define shared-cli
  (cli-specs
   [verbose -v count "show more compiler messages"]
   [output-file -o (string "<output>") "write output to <output>"]
   [libdirs -L (list "<libdir>") "add <libdir> to library-directories"]
   [srcdirs -s (list "<srcdir>") "add <srcdir> to source-directories"]
   [rt-libs --rtlib (list "<lib>" ...)
    '("visit compiled libraries <lib> ... before compiling <source>;"
      "these libraries are added to <output> unless otherwise"
      "specified, in which case they must be provided at run time."
      "Look for <lib> ... in library-directories (-L) if not found.")]
   [help -h --help (list "[<section>]" ...)
    (format "display help, <section>={狺撄}" help-sections)]
   [version --version bool "print version information"]
   ))

(define library-cli
  (cli-specs
   [source-file (string "<source>") "library source filename (or -- <source>)"]
   [as-library --library bool "make a compiled library; <output> omits --rtlib libraries"
    (usage show req)]))

(define app-cli
  (cli-specs
   [source-file (string "<source>") "program source filename (or -- <source>)"]
   [component -c bool "make component; <output> omits --rtlib libraries"
    (conflicts '(boot-files))]
   [boot-files -b (list "<boot-file>")
    "make stand-alone program including <boot-file>"]
   [libs-visible --libs-visible bool
    "make imported libraries visible to eval"]))

(define swish-lib?
  (let ([libs (filter (lambda (lib) (match lib [(swish . ,_) #t] [,_ #f])) (library-list))])
    (lambda (lib)
      (member lib libs))))

(define swish-libdir (path-parent (osi_get_executable_path)))

(define (system-libdir swish-wpo?)
  (path-combine swish-libdir (if swish-wpo? "wpo" "lib")))

(define swish-core-library-filename
  (get-real-path (path-combine swish-libdir "swish-core.library")))

(define swish-library-filename
  (get-real-path (path-combine swish-libdir "swish.library")))

(define (swish-library-file? full-path)
  (or (string=? full-path swish-core-library-filename)
      (string=? full-path swish-library-filename)))

(define prevent-wpo (make-hashtable equal-hash equal?))

(define (library-setup swish-wpo? libdirs rt-libs)
  (when swish-wpo?
    ;; Allow whole-program optimization for swish libraries in stand-alone
    ;; programs, but not in libraries or compiled scripts where we'll be loading
    ;; the swish boot file.
    (for-each
     (lambda (lib)
       (match lib
         [(swish . ,_) (hashtable-set! prevent-wpo lib #f)]
         [,_ (void)]))
     (library-list)))
  ;; Disallow whole-program optimization for (swish app-core) and its
  ;; dependencies so we can bake these libraries into the boot file for
  ;; a stand-alone application where they can be used in the boot process.
  (let forbid! ([lib* '((swish app-core))])
    (match lib*
      [(,lib . ,more)
       (hashtable-set! prevent-wpo lib #t)
       (forbid! (library-requirements lib))
       (forbid! more)]
      [() (void)]))
  ;; visit --rtlib libraries (even swish libraries, so library-object-filename
  ;; points to a swish library file instead of swish.boot)
  (for-each visit rt-libs)
  ;; Disallow whole-program optimization for --rtlib libraries that will
  ;; be loaded separately at run time.
  (for-each
   (lambda (lib)
     (unless (hashtable-contains? prevent-wpo lib)
       (hashtable-set! prevent-wpo lib #t)))
   (library-list))
  (library-directories (cons (system-libdir swish-wpo?) libdirs))
  (when (> (verbosity) 1)
    (printf "Library directories:\n筌铪扉怛狎溟蝈泗矧殄螬┅ㄤ彐轭麒ㄡ痧侯犴濠ㄤ彐轭ㄦ衢骓狎珞ㄡ痧禊弪蝻蜴麒骓狎珞┅ㄤ彐轭黩狃轭溴铘翦趔黩狃翦ㄣ躜蝈铘秕麴豸痫螋ōㄨ屐瓠黩狃鏖漪瑭轭溴铘轭溴铘轭溴铘觑轭翦趔＼箴徙濠┅ㄤ彐轭瀛簌铘狲屮犴痨簌铘狲蝓戾ī郇ㄣ犰翦ㄢ彗轭黩狃汜祆④睥黩狃翦④睥┅荸ㄤ彐轭瀛簌铘狲犷箦泗轱铙簌铘狲蝓戾ī郇蝈聃弩翦郇脲怙澌戾ㄛ箦泗轱铙蝈聃弩翦漭ㄤ彐轭翳躅塍蝈眈ｆ扉篝ㄡ钿矧磲灬礅溽礤眈箦泗轱铙┅Ж脲┅灬礅溽ī怙澌┅┅ㄤㄛ痼翳躅塍ㄣ潋痼┹垠屦④睥荸è铛祆痼┅ㄤ轶痨狴箦皓è汜痼┅┅荸ㄤ彐轭扉篝轸屙轸屙翦趔痱轭翩蠢轸屙黩狃翦ㄣ躜蝈铘秕麴豸痫螋ōㄨ屐瓠黩狃鏖漪瑭订觑轭翦趔＼箴徙濠铄黛轭濠ㄤ彐轭躞徵箬矧艨箦泗轱铙梏ㄤ彐轭箦戾泗邃ㄣ镱郇疳轵箦泗轱铙箦泗轱铙垠栾螋Ж躞徵濠坼祗Ж躞徵桢祓┹┅ㄡ铢箦泗轱铙箦戾泗邃郇犰躞徵濠ㄤ轶痨狴躞徵⒄筢珏孩麒ㄡ痧孱箬狎邃沆狃瓠沆椹ㄤ轶痨狴躞徵矧孩麒ㄡ痧孱箬狎邃沆扉怛狎沆椹┹郇犰桢祓麒孱梏ㄨ狍梏徕戾溴戾翦梏ц屐皓ㄤ轶痨狴镳糸镱箬狎邃沆梏痱轭翩④序镧蜥翎蜱弭镳糸镱蠛茴ㄤ轶痨狴镳糸镱狃瓠沆梏痱轭翩④涕怛狎翎蜱弭镳糸镱蠛茴ㄤ轶痨狴镳糸镱扉怛狎沆梏┹郇犰溴翎殪螬ㄤ彐轭泱鑫挝潇ㄦ矧磲泱鳋狺潇膦ㄣ犰飙鏖翳鲠祯弩筱桢礤鲥蝮轱瞽铛礅弪扉篝┅黩狃麒汜磲脲泔眇殪邃扉怛狎泔眇镱孱痱镧蜥憩篝犷洵犰镱痱镧蜥憩矧扉铍邃痱镧蜥懋⒙溴驷蹯衄麒泸遽翦扉铍邃痱镧蜥懋茴④睥⒃泔眇殪扉怛狎箴邈殒扉怛狎澡蝈篚祠轭泔眇殪邃扉怛狎磲⑩祜徜邃屮痨殂轸禊矧躞邃狍幄麒螋扉狎珲礤铘麒孱泔眇殪轭雉桢颌㈧殁蜥蜷弩矧痱镧蜥眢茴④睥⒃泸遽翦泔眇镱孱痱镧蜥憩箴邈殒惝泔眇镱孱痱镧蜥滹弩铒蝓镱㈤趔秣瞵怩磲忮祜徜邃怡犷雉桢痱镧蜥懋茴④睥⒆桢睥麒泸遽翦泔眇殪邃扉怛狎矧泔眇镱孱痱镧蜥憩翳蝈篚祠轭硷豸瘐艟泔铘衢铙泔眇殪邃泔溴骘俭秕蜚寰犷翳躞弪扉怛狎殄轸蝈驽蝈钽弩怩屮沆蹁弩⑩蹰祠轭扉怛狎殄犷扉怛狎殄篚痧扉邃鲩螋扉猱茴④睥⒃泸遽翦篝犷洵犰镱痱镧蜥憩箴邈殒犷痱秭殇忉箦怙雉骈戾麒泸遽翦篝犷洵犰镱痱镧蜥恝⑩泔瘗轭翳篦轶屮邈豸徕戾麸硷豸骈戾劲⑨钿泸遽糸铉怙雉骈戾硷豸骈戾井怙雉泔铘衢铋铉遽汨ㄦ矧磲恂徕镲舡骈戾＼泊癌㈤矧溴颥翳蝓瞽糸礤扉怛狎殄轭沆蹁邃鲩螋扉猬Ⅳ桢扉怛狎殄蝈聃轵邃怡俭秕蜚寰犷翳泔眇殪邃泔溴㈡矧俭秕蜚寰茴④睥⒆桢蝓瞵篝犷洵犰镱痱镧蜥砗茴扉篝轸屙⒈㈧镝潴描妃鱼桢礤螈泱鑫挝潇③组钿秣镱禊莠扉篝轸屙⒉㈧镝潴翳痱镧蜥怙雉骈戾翳孱扉篝轸屙⒊㈤铞镫弩沲篝镯筱桢礤篝狎栳钿戾溴筱蜷忮忮祜鳟茴黩狃⒃泸遽翦扉铍邃痱镧蜥憩镯轸翳镳糸镱茴茴⒆桢蝓瞵扉铍邃痱镧蜥汜祆篦轶麸很睥扉篝轸屙⒈㈧镝描妃鱼桢礤螈泱鑫挝潇③组钿秣镱禊莠扉篝轸屙⒉㈧镝描妃鱼桢礤疱糸翦怙雉犷筱桢礤怙雉扉篝轸屙⒊㈧镝翳篝犷溽蜾篦轶怙雉骈戾翳孱扉篝轸屙⒋㈤铞镫篦轶璀篝狎鏖翳翳泔眇殪邃痱镧蜥狍翳骈蝮狎珲礤铘㈡镬祜麇怡翳狎珲礤铘痱秭殇邃镱翳泔眄犷扉铄茴黩狃⑾篝狎舡躔痱镧蜥扉铍邃篝犷洵犰镱瀣矧筱蜷痿┖茴扉篝轸屙⒈Ⅲ弭狃鸷钺礤狃鸷疳翳泔眄犷洵扉铄犷泔眄犷洵扉铄狎珲礤铘螈扉篝轸屙⒉㈤铙翎祆犷屮沐痿轱栳钿戾翳狒痱轭趔狃鸷钺礤殒铒瞽驷祗瀣犷洧扉篝轸屙⒊㈤铞镫弩翳痱镧蜥泔溴黩狃④睥⒚镯痖扉铉扉铍邃痱镧蜥矧篝犷洵犰镱痱镧蜥轭泔蝠矧狒弩犷螋扉扉怛狎殄螈溟蝈泗禊轭麸翳硷豸瘐艟骈戾⑸痱镧蜥祜徜雉桢泔眇殪邃扉怛狎殄屮痨殂轸禊狒蝓糸礤轸眭篝犰箫祜徜⑨铢螋扉扉怛狎殄翳妁蝈聃轵瀹⒃桢泔眇殪弪箅轲螋扉扉怛狎殄漉蜷铉麒镬瀛扉怛狎矧麒镬瀛痱镧蜥恝镳糸黹狒轱町茴┹郇犰屮犴痨弩痱轭翩⑴犴痨弩很睥铄黛轭濠ㄥ犴痨麒骘疱糸翦骘锂篌⑩蹰熹篝犷洵犰镱堍骘镘屮邈豸徕戾骝镯堍骘锂篌堍Ⅴ箝铉翳筢礤疱糸翦怙雉翳狒篦轶躞弩茴ㄥ犴痨麒骘疱糸翦筱桢礤骘锂篌⑩蹰熹篝犷洵犰镱堍骘镘屮邈豸徕戾骝镯堍骘锂篌堍躞轭纰Ⅳ桢筢礤疱糸翦怙雉犷筱桢礤怙雉翳狒篦轶躞弩⑸麇箴邈殒殄镱禊筱桢礤翳蝈篚祠轭骘锂怙雉黠蹯洧㈩雉忮趄蹯篝犷洵犰镱瀣箝钽筱桢礤怙雉蝈聃轵弩疱糸翦怙雉茴ㄥ犴痨麒骘疱糸翦筱桢礤螋扉篦轶骘锂篌⑩蹰熹篝犷洵犰镱堍骘镘屮邈豸徕戾骝镯堍骘锂篌堍躞轭翳澧Ⅲ犴疱糸翦怙雉犷筱桢礤怙雉翳狒篦轶躞弩犷磲脲翳澧Ⅲ翎钿狎篦轶扉怛狎殄狯衢灬忪狒蝓糸礤箫翳狒堍骘镘汜泔眇殪泔溴翳狒躞弩翳矬扉怛狎殄螽茴ㄥ犴痨麒骘锂扉怛狎扉怛狎骘锂篌泔眇殪弩翳堍骘锂篌堍扉怛狎麸堍骘锂扉怛狎堍犷珏铄蜥翦螈④㈡镲黟镘骘躞怡麒镬瀛痱镧蜥镳糸黹狒轱町茴ㄥ犴痨麒忉虍篌忉虍泔眇镱孱螋扉骘锂扉怛狎忉虍扉怛狎泔眇殪弩翳堍忉虍篌堍痱镧蜥麸堍忉虍泔眇镱孱糗麒殂屮疱泗螈④㈡镲扉怛狎堍犷堍忉虍扉怛狎堍麸忮痱秭殇邃狒蝓糸礤荸戾ㄛ轭鲠扉ㄦ镬洵蜷玷蝈眈箦泗轱铙桢祓箦泗轱铙┹躅戾篌铛祆轭鲠扉洎ㄦ衢Ⅴ铗邈镧铋邃桢祓箦泗轱铪鸷狺戾铉翳轭鲠扉洎轭鲠扉洎┅ㄥ轸癌ㄤ彐轭瀛簌铘狲翎蜱弭汜箦簌铘狲蝓戾ī郇屮痱郇氚氡灏灞换蝈聃轵犰汜箦ㄥ聃犰Ж泔眇镱孱扉怛狎扉铍邃篝犷洵犰镱濠箫螋灬礅溽ㄡ猢篝蜷铉伎簌礅镬倔趄轭岍簌礅镬倔趄轭猢┅ㄡ痧禊狃疱钿ㄤ狒蹴è氚氡┅┅戾ㄛ翎蜱弭屮痱荸ㄣ狍屮痱郇氚氡灏灞坼祗磲翥翎蜱弭┹┅荸ㄤ彐轭疳蝮瀛扉怛狎扉猢疳蜥礤翦蜷ㄛ扉怛狎溟蝈泗矧殄扉廨扉怛狎溟蝈泗矧殄螬┅换泸遽翦繇骈戾换镱翳筢礤骈戾簌篝屙狍忉箝蟋屐箦蝈钺礤疳翳鏖祆驷殪换鏖翳腩秣屮翦铙轱瞵箝钽泔眇殪瀛麒镬瀛痱镧蜥蝈痨徙弩换屮翦铙轱鏖翳黟ㄤ彐轭繇瓠骈戾钺礤忉箝螬ㄦ矧磲岘扯虍繇稷疳翳蝻雉忉箝螬ㄢ翦鲥泗矧蹰铘蝈矬檫磲脲啧蹰洎ъ轸綮倍┅ㄤ彐轭ㄣ栳铉瀛屮翦铙轱骖铄鳝屮舂篝蜷铉狃疱钿疳翳蝻雉骖铄鳝屮舂ㄤ彐轭痨狒骘蝽怙雉骈戾秕麴豸骖篝蜷铉狃疱钿ㄣ狍磲汨轭瀛豉疱郇岫铘槌铘翎额糸愁舂换项咨纬铂喻轶篝蜷痼翳屮屮翦铙轱麒孱祜镫轭骘翳怙雉换骈戾狍描妃鱼桢礤滹弩箫麇篝蜷屮麒孱泸遽糸铉翳骈戾ㄩ篝蜷铉汩娇㈠澧疳翳屮翦铙轱秕麴豸骖┅疳翳蝻雉秕麴豸骖秕麴豸骖┹坼祗秕麴豸骖荸怙雉┅换麸栳钿戾翳轭珞扉脲汨妃筱桢礤箪螈汨妃筱桢礤箫ㄤ彐轭ㄣ栳铉瀛篚骀轼骈戾钺礤镬洵屮铄鳝屮舂ㄡ钿ㄥ钿蟓鏖翳骈戾钺礤镬洵屮舂篝蜷铉狃疱钿篚怏趄轭骈戾钺礤ō篝蜷铉戾铉翳骈戾钺礤篝蜷铉戾铉翳镬洵屮舂┅铄鳝屮舂┅ㄤ彐轭镡赍泗骈戾钺礤箫躜沐骖矧磲灬礅溽痱ㄣ栳铉瀛篚骀轼箫躜沐骖ㄣ狎痱ㄣ潋痱┅扉怛狎屮翦铙轱铙┅ㄤ彐轭ㄣ镳轲镳ㄤ彐轭怩骒孱ㄥ痿倍┅ㄤ彐轭怩磲脲怡翦鲥泗矧怩骒孱┅戾沭ī戾ㄛㄧ弭怡翦鲥泗矧睢轲怩怩骒孱┹躅戾篌ㄥ镦镡赍泗瞟瘐舡怡翦鲥泗矧镳怩瞟ㄣ皓┅┅ㄤ彐轭ㄣ镳骈戾轭瘐舡骖秕麴豸骖戾ㄛ镳镳孱忾钺蝙骈戾麸蝈痨徙秕麴豸骖┹垌镤ㄢ轸鏖箦犷ｏ贩俭翎艟盹溴ㄧ弭篝狒轭瘐舡骖┅┹镱屮轸ㄢ彗轭ㄣ祜箦痫螋镳箦舡骈戾盹溴秕麴豸骖盹溴┅ㄣ镳麸痫螋镳扉篝轭瘐舡骖┅┅ㄤ彐轭ㄣ镳麸痫螋镳轭瘐舡骖ㄦ矧遽汨灬礅溽ㄩ铕豸骖戾ㄛ轲镳孱忾钺蝙骈戾麸蝈徜轭瘐舡骖┹镱屮轸ㄣ祜箦痫螋轲ㄣ镳轲镳┅┅轭瘐舡骖┅ㄤ彐轭蝽骈戾钺礤ㄣ狒汨蝈盹鲥骈戾骈戾钺礤┅换黩狃泔铘孱趔镦箫躜沐骖轭麸瓠戾鲥痱镧蜥鏖翳篝犷溽蜾轫痫螋ㄤ彐轭ㄤ锃泔眇殪瀛痱镧蜥箫躜沐骖溴篝鏖翳箧洵箫躜沐镦骟弭箫躜沐骖灬礅溽ㄩ箧箫躜沐镦骟弭ㄤ彐轭犷铒翎翦洵箫躜沐ㄧ弭溽趱懑犷铒翎糸镱蟓犰轲箧箫躜沐镦骟弭┅ㄤ彐轭漉眄犷铒翎糸镱磲翥犷铒翎翦洵箫躜沐郇擤ㄡ铑雉狒轱瞽箫躜沐┹郜磲脲箫躜沐镡赍泗箧癌荸ㄤ彐轭ㄡ铑雉狒骘蝽磲脲犷铒翎糸镱骘蝽漉眄犷铒翎糸镱骘蝽┅ㄤ彐轭痱镧蜥换箫躜沐骖眭篝铒躞麸瓠戾鲥飙痱镧蜥憩箝钽轸轶箴扉沐轭狍怙澌啜ㄡ铑雉狒麸瓠戾鲥飙痱镧蜥愆ㄡ铑雉狒Ж轫痫螋筱桢礤篦轶轫痫螋螬┅泪铑雉狒邃箫躜沐┅ㄣ镯痖戾麸骈戾扉篝痱镧蜥愆溴篝箧洎┅ㄤ彐轭ㄣ镯痖戾桢祓箫躜沐骖镡戥骖翎蜱弭豉疱ㄤ彐轭溴驷蹯舡扉怛狎箦狎汨扉怛狎箦狎汨栳钿戾颟疳蜥礤翦蜷ㄛ扉怛狎箦狎汨栳钿戾灬礅溽麒疳翳溟颡犰飙屮舄戾舡鲠祯弩ㄛ篁悱疳翳镡戥疳翳镡戥屮轶趔咯ㄤ彐狨祠扉怛狎箦狎汨麒疳翳溟颡犰飙屮舄┹鲠祯弩篁悱疳翳镡戥疳翳ㄡ钿镡戥屮轶趔换滹瞌蝈怩殪殒麇顼翳轶扉怛狎鲩螋扉换殒麇栳鲥箫躜沐犷麇蝈屮疱泗邃麸珏铄蜥翦换黟骈戾骘翳轶扉怛狎翳孱骈钿轭箫骈戾换轶铒孱秕玷麇犰箫铄邃犷躔麸溽翦黟铫骈戾换骘翳躞怡泔眇殪瀛黟矧铒篁悱疳翳ㄨ狍梏徕戾蝈痱弼孱舡黟疳翳ｆ铒ㄧ孱弪狒瀛黟锃骈戾螬戾ㄛ黟锃骈戾篝蜷铉狃疱钿疳翳蝻雉镡戥疳翳黟铫┹ㄡ钿ㄦ殪瀛屮轶趔黟锃骈戾换徙泔躅骘祜鳝蝈箫祯糸镱绕糸礤篝犴痼糸礤窘ㄦ殪瀛盹溟骈汜糸镱糸礤黟锃骈戾ㄦ殪瀛盹溟骈汜糸镱糸礤篁悱疳翳┅┅┅┅┹坫镯痖戾扉怛狎栳钿戾灬礅溽箫躜沐溴篝麒孱鲥蜮矬轸癌痱轭翩泔眇殪轭彳睥箫躜沐┅ㄣ镯痖戾扉怛狎箫躜沐溴篝┅荸翎蜱弭汜箦翎蜱弭豉疱郇扉怛狎ㄣ镯痖戾扉怛狎箫躜沐骖镡戥骖┹郇泔眇镱孱扉铍邃篝犷洵犰镱濠ㄤ锃泔眇殪瀛痱镧蜥箫躜沐骖镡戥骖┹┅ㄤ彐轭ㄣ镯痖戾黟黟锃骈戾秕麴豸骖翎蜱弭豉疱ㄤ彐轭溴驷蹯舡扉怛狎箦狎汨扉怛狎箦狎汨栳钿戾颟疳蜥礤翦蜷ㄛ扉怛狎箦狎汨栳钿戾灬礅溽麒疳翳溟颡犰飙屮舄ㄩ矧磲灬礅溽皓磲翥郇黟铫ｔ郜ｆ荸犰飙屮舄ㄩㄨ狍梏徕戾蝈痱弼孱舡黟疳翳ｆ鲠祯弩ｆｆｆㄤ彐狨祠扉怛狎箦狎汨麒疳翳溟颡犰飙屮舄┅磲翥ㄣ狒汨扉怛狎镡赍泗骈戾钺礤疳翳┅郜镡戥骈戾ㄧ踽蜾篝蜷铉镡戥骈戾┅鲠祯弩ｆ镡戥骈戾ㄦ殪瀛屮轶趔镡戥骈戾┅郜ㄤ彐狨祠扉怛狎箦狎汨麒疳翳溟颡犰飙屮舄┹┅┹翎蜱弭汜箦翎蜱弭豉疱郇扉怛狎戾ㄛ黹篌轭ㄣ镯痖戾麒镬瀛扉怛狎黟锃骈戾秕麴豸骖┹蝈钺礤疳翳黟锃骈戾ㄣ栳铉瀛屮翦铙轱秕麴豸骖黟铫┅黹篌轭绌郇泔眇镱孱扉铍邃篝犷洵犰镱濠戾ㄛ黹篌轭ㄣ镯痖戾麒镬瀛痱镧蜥黟锃骈戾秕麴豸骖镳ъ殁蟓鲩箝忪濠┹蝽黟锃骈戾黹篌轭绌荸┅ㄤ彐轭ㄤ锃泔眇殪箫躜沐骖秕麴豸骖篦轶璀黟锟翎蜱弭豉疱戾舄ㄛ镡戥骖镡赍泗骈戾钺礤箫躜沐骖┹埕眇骖ㄩ镡戥骖ｆ繇瓠骈戾钺礤秕麴豸骖┅埏怅骖矧镡戥骖繇瓠骖┹镱屮轸翎蜱弭汜箦翎蜱弭豉疱郇扉怛狎麒孱繇瓠骖蝽繇瓠骖┅郇泔眇镱孱扉铍邃篝犷洵犰镱濠蝽镡戥骖┹麒孱鲥蜮矬轸癌痱轭翩泔眇殪轭彳睥箫躜沐骈戾┅疳蜥礤翦蜷ㄛ珏铄蜥翦轭箴邈麸颦轭骘蝽狒轱ｆ坨孱弪狒瀛痱镢邃躜瀛箫躜沐轭骘蝽狒轱ｔ坨孱弪狒瀛黟锃骈戾ｔ坫镯痖戾轫痫螋邃扉怛狎殄ｔ坫镯痖戾骈戾礤篌徵ｆ荸ㄣ镯痖戾桢祓箫躜沐骖镡戥骖翎蜱弭豉疱戾舄ㄛ黟锃骈戾ㄣ栳铉瀛屮翦铙轱镡戥骖黟铫┹垤殁ㄣ镯痖戾黟黟锃骈戾秕麴豸骖翎蜱弭豉疱┹垌轶箝铉扉怏换郁犷洵犰镱痱镧蜥箬秕熹栳鲥骘躅犰蝈聃轵邃铒瞽篦轶扉怛狎殄螽换涉篦轶扉怛狎殄狎轭泔蝠矧狒邃鲩麒镬瀛痱镧蜥镳糸黹狒轱瞵换翳孱麇眭篝犰箫栳鲥骘躅翳黟骈戾骘翳矬扉怛狎殄螽换腻疱钿孱痱镧蜥眢汜躞篦轶扉怛狎殄轭沆蹁邃轭蝓铘轫瀣换狍汜篝犷洵犰镱痱镧蜥眢翳狒屮痨殂轸禊箴邈殒螋扉篦轶璁ㄩ篦轶璀黟锟扉怏蝈眇篦轶璀扉饪扉怏┅荸黹篌轭绛扉怏┅┅ㄤ彐轭怙雉骈戾磲戾ㄛ汜汨ｆ荸灬礅溽ī躅戾篌汜汨箦簟汜汨ㄢ蹰熹怙雉骈戾磲皓┅汜汨濠┅ㄤ彐轭ㄢ蹰熹怙雉骈戾磲皓戾舡鲠祯弩ㄛ麸篝溟骝镯篝滹豸骝镯篝溴蝌矬痖洎箴狩瞽矬痱镢弩矬檫珏暨屮邈豸徕戾唣狒瑭Ж鲥蜮矬澧箦戽┹ㄣ祜箦痫螋麸篝溟瞟戾ㄛ骝镯篝溴蝌ㄢ轭狎觉翩骝镯篝溴蝌┹戾祓ㄛ犰Ж┹戾ㄛ扉铄ㄧ弭扉铄骝镯篝溴蝌┹ㄩㄥ镦镡赍泗扉铄犰祓磲翥痱彗屮瓠磲翥蝈⑥趄轭ó┸墚苘苘镳孱邃茯郡扉铄郇骖ㄣ镱ㄣ镱疳翳灬篝骖骖犰螬郜犰筝┅┅┅┅ㄤ彐轭蝈箫祧瀛怙雉骈戾怙雉ㄣ镱郇蝈珲灬颦骈戾怙雉怙雉郇狍箫怙雉ㄢ镲舡骈戾磲皓骄沅蜉郇狍箫篝蜷铉狃疱钿怙雉怙雉ㄢ镲舡骈戾磲皓骄沅蜉坼祗ㄦ衢汜铑雉蝈箫祧怙雉骈戾幄怙雉┹┅ㄤ彐轭ㄦ轭洵螋扉螋扉扉猸溟蝮ㄩ蝈珲灬颦骈戾螋扉猢ㄧ弭蝈犰疳翳螋扉猢矧磲灬礅溽扉猸溟颟戾ㄛ骈戾钺礤疳翳泔礅轭ㄣ潋扉猸溟颟螋扉猢荸ㄡ钿蝈珲灬颦骈戾骈戾钺礤ㄧ弭蝈犰疳翳骈戾钺礤┅┅扉猸溟蝮┅换蝈箫祧麸蝈犰疳翳钺礤屮疳钿簌篝屙扉怛狎殄蠡痱弩弪鲥矧溴蚧脲屦骈蝮镢沲蝈钽ㄤ彐轭蝈箫祧瀛螋扉怏螋扉猹扉猸溟蝮ㄤ彐轭ㄣ镱蟓躅轳蹂螋扉祗ㄩ礤礅弪螋扉祗祗ㄣ镱螋扉祗┅ㄤ彐轭ㄡ滗祗螋扉猢ㄣ镱郇骈钿螋扉螋扉扉猸溟蝮骄灬礅溽ㄦ殪孱犴濠ㄣ镱蟓躅轳蹂骈戾钺礤祗┅郇羼踽炜螋扉Ⅲ鏖箬ㄣ镱蟓躅轳蹂篦轶璀扉怛狎骈戾钺礤ㄣ镱蟓躅轳蹂篦轶璀泔蝈扉怛狎骈戾钺礤祗┅坼祗ㄦ衢汜铑雉蝈箫祧螋扉螈螋扉猢荸蝈鲥蝮ㄦ镬洵戾骠徜Ж螋扉猹┅ㄤ彐轭蝈箫祧瀛黹篌轭绛扉怏翎蜱弭豉疱螋扉怏黹篌轭绛扉怏ㄤ彐轭梏磲脲栳箬翎忪篝蜷铉栳箬篝蜷铉娇┅ㄤ彐轭铒骈戾脲ㄤ彐轭ㄡ滗脲扉猢ㄨ狍梏徕戾躔溽翦梏脲灬礅溽ㄣ镱扉┅Ж┅ㄦ矧遽汨灬礅溽扉猢磲翥ㄣ狒汨ㄧ弭蝈犰疳翳扉怛狎镡赍泗骈戾钺礤扉猢┅郏ㄅ厣蝈狍镱ㄡ滗铒骈戾脲扉猢郜镡戥骈戾ㄧ踽蜾篝蜷铉镡戥骈戾┅ㄡ滗镡戥骈戾扉猢荸黹篌轭绛扉怏换序躅螋扉扉怛狎殄骝镯黹篌轭绛扉怏殒铄邃邃麒孱翎蜱弭汜箦翎蜱弭豉疱郇泔眇镱孱扉怛狎鲥蜮矬轸癌郇扉铍邃篝犷洵犰镱濠ｔ荸ㄦ矧遽汨灬礅溽螋扉猢ㄨ狍梏徕戾溴戾翦梏螋扉猢螋扉怏┅戾舡鲠祯弩ㄛ脲鲠祗ㄨ狍梏徕戾孱趄殄梏┹戾ㄛ骈戾鲥泗矧眷轶脲螬垤殁鲥泗矧眷轶鲠祗┹翎蜱弭汜箦翎蜱弭豉疱郇泔眇镱孱扉怛狎磲翥箫螋灬礅溽ㄡ猢篝蜷铉伎ㄣ狎岍ㄣ狎猢┅磲泔铙骈戾扉怏┅郇鲲殇┹郜麸痱秭殇痱轭翩⒃桢箦扉怛狎殄眭篝忮痱秭殇邃狒蝓糸礤很睥ㄦ矧遽汨灬礅溽皓磲翥郇镡戥骈戾扉怛狎殄螬黩狃翦ㄣ躜蝈铘秕麴豸痫螋ㄨ屐瓠黩狃鏖漪瑭ㄩㄥ聃犰铒骈戾脲镡戥骈戾ㄦ矧磲⒚犷铒溴翦蝽轭骈戾翳狒痱秭殇弩湖簋扉怛狎殄螬ㄦ矧磲狺累湖簋茛镡戥骈戾ㄡ钿窘鲥蜮矬轸博扉怛狎殄螬┅铄黛轭濠荸麸痱秭殇濠荸郇扉铍邃篝犷洵犰镱濠ㄣ镱郇栳箬翎忪瀛蝈梏铒骈戾脲ｆ骄灬礅溽黹篌轭绌ㄦ衢汜铑雉蝈箫祧黹篌轭扉怛狎鲤簋戾铉翳黹篌轭绌黹篌轭绌┹郇鲥蜮矬轸癌郇疳轵扉怏痱弭豉痱轭扉怏痱轭翩⒘滗邃鏖翳秕麒镬瀛痱镧蜥镳糸黹狒轱詈簋\n" libs)])])
      files)))

(define (show-files target-type app-boot boot-files rt-libs other-libs source-fn)
  (when (> (verbosity) 1)
    (printf "making a program@[ boot file s] from:" target-type app-boot)
    (printf "@[茴狺茛怙雉骈戾螬痱轭翩茴螋扉狺螋扉怏痱轭翩茴狺雉桢颦扉怏痱轭翩④彳睥箫躜沐骖┅ㄤ彐轭趄疳蝮濠ㄤ彐轭痱镡戾ｆㄤ彐轭扉猸镳疳蝮瀛泔眄犷洵扉铄狎珲礤铘ㄡ痧孱弩汜疱栳翥箬狎邃沆扉怛狎沆椹ㄣ镯磲钿扉铄狎珲礤铘螬灬礅溽躅戾篌痱镡戾箦簟痱镡戾┅┅ㄩ扉猸镳п蟓扉怛狎ㄩ痱镡戾ㄡ痧禊驷殪痱镡戾愆扉猸镳舂疳蝮瀛泔眄犷洵扉铄狎珲礤铘ㄡ痧孱弩汜疱栳翥箬狎邃沆狃瓠沆椹┅ㄤ彐轭镳趄疳蝮濠ㄤ彐轭箫躜沐骈戾磲翥镳у痨殂轸箫躜沐郏镳箫躜沐骈戾┹郇镳箫躜沐骈戾┹郇箫躜沐骖ㄡ钿铒镳箫躜沐骈戾┅箫躜沐骖┹郜ｆ荸ㄣ镱郇镳篁沅轵螬骄灬礅溽篁沅轵螬箫躜沐溟蝈泗矧殄ㄡ痧孱篁沅轵箫躜沐溟蝈泗矧殄螬┅┹ㄣ镱郇弪锟ㄨ狍梏徕戾箝镳舂┅躞徵ｔЖｆ┹郇镳ц屐皓骄灬礅溽箦泗轱铙躞徵ｆ磲篝蜷铉倔礅镬箦泗轱铙镳舂┅郇镳鲥蝮轱瞟痱轭翩皱蝮轱岍茴麒箫骠麽蝈鲥蝮轱篦轶瑭箫骠麽蝈蝈鲩箝镱篦轶瑭┹坼祗戾舄ㄛ箫躜沐骖矧箫躜沐骈戾ㄦ衢Ⅱ羼蹰蝈箝铉戾箫躜沐骈戾钺礤┅埏豸瘐舡骖矧镳э豸瘐舡骈戾ㄦ衢Ⅱ羼蹰蝈秕麴豸骈戾钺礤┅埕狎珏舡豉疱ㄣ镱郇栳箬翎忪瀛蝈镳舂п蟓扉怛狎ｆъ殁蜥蝙郇镳р镲舡骈戾螬篝犷洵犰镱遢郇镳с镯痫铄铘с镯痫铄铘坼祗ъ轭脲漭┹垤殁溟蝮ㄦ镬洵蜷玷灬礅溽徙悌ㄡ痧孱疳蝮瀛扉怛狎徙悌扉怛狎溟蝈泗矧殄螬矧镳ъ殁溟蝮Ж┅┹垓舡扉怏蝈箫祧瀛螋扉怏矧镳螋扉怏Ж┅扉怃轵螬荸鲥蜮矬轸矧镳鲥蜮矬濠癌ㄩ眇矧舡铒糸纟鲥蜮矬轸博翎蜱弭汜箦翎蜱弭豉疱郇扉怛狎扉怛狎箦趱ｆ扉怃轵螋扉怏蝈箫祧瀛黹篌轭绛扉怏ъ殁蜥蝙螋扉怏ㄤ锃泔眇殪箫躜沐骖秕麴豸骖ｆъ殁蜥蝙┅郇篝犷洵犰镱濠换龄祜汜糸镱镦篦轶簌篝屙黟骈戾镱禊殒麇蝈怩殪溟铉换篝犷洵犰镱痱镧蜥ㄢ镲舡骈戾铒瞽屙痿┊戾舄ㄛ怙雉骈戾磲蝈箫祧瀛怙雉骈戾镳р镲舡骈戾螬┹垠鏖箬黟锟矧铛祆螋扉怏换滹瞌躞黟骘篦轶扉怛狎殒麇蝈轭沆蹁轭轸狍换蝓瞽糸礤扉怛狎屐箦麇泔蹯漉痨殂狒泔溴铒礤礅弪篦轶璀扉怛狎骈戾钺礤螋扉怏┅┹垓舡扉怏换领麽轭沆蹁篦轶璀泔蝈扉怛狎狍螋扉犷溟筢忪换麒镬瀛痱镧蜥镳糸黹狒轱骘篦轶狃瓠泔蝈犷轸换溴疱钿孱汩弩箝钽翳弩狎蝈聃轵邃怡翳怙雉痱镢弩换骘篝犷洵犰镱狃痼犷麇滹瞌麽铘麸蜷箅漉痨殂狒轭换翳矬扉怛狎殄鏖翳轭翳泔眇殪邃麸瓠戾鲥痱镧蜥轸箦戽ㄩ礤礅弪篦轶璀泔蝈扉怛狎骈戾钺礤螋扉怏螋扉怏ㄣ镱篦轶璀泔蝈扉怛狎骈戾钺礤螋扉怏┅圻扉怛狎箦趱篦轶璀黟锟扉怃轵螋扉怏┹埏翳弪扉怏换祜徜泔眇殪邃骝镯痫螋驷殪殒玳鲥泔眇蝈篌邃换铒翦翳狒痫螋骈戾泔眇蝈篌邃轲黠螂镱禊骘骈戾痫螋蟋换犷滹弩铒黠螂骘怡翦鲥泗矧轭瘐舡痫螋换铒痱镡戾忮汜躞泔眇殪瀛麸骈戾鏖祆泔眇蝈篌躞灬翦疳蜥礤翦蜷ㄛ泔眇殪瀛泔眇蝈篌邃ｆ荸蝈箫祧瀛黹篌轭绛扉怏篝犷洵犰镱螋扉怏ㄤ锃泔眇殪箫躜沐骖秕麴豸骖篦轶璀黟锟翎蜱弭豉疱┅┹坩痧怙雉痨狒骘蝽怙雉骈戾秕麴豸骖┹坫镯痖戾洵泔溴戾ㄛ轲镳孱忾钺蝙骈戾麸蝈徜秕麴豸骖┹镱屮轸ㄣ祜箦痫螋轲ㄧ弭怡翦鲥泗矧犰轲┅┹箬秣骈戾翎蜱弭豉疱狃瓠怙雉怙雉骈戾螋扉怏雉桢颦扉怏箫躜沐骖换澡轶屮痱弩箝镱眭篝铒蝈驽蝈钽屮痫螋翳狒磲换疳螋殂轲狒轭麒镬瀛痱镧蜥镳糸黹狒轱瞵箝钽翳狒泔蹯换蝈篚祠轭漉痨殂狒扉怛狎轭轸獒扉狒轱鏖翳轭翳泔眇殪邃换泔溴义驽蝈钽轭屮痫螋痱秭殇邃怡篦轶璀泔蝈扉怛狎轶换骈铄箝钽翳妁狎屮沆蹁邃骝镯黟锂ㄣ镯痖戾麸骈戾啜篚痧蝈篌珧邋糸铉ｔ戾ㄛ矧殓筱桢礤篝狎舂荸筱桢礤篝狎灬礅溽狎珞筱桢礤篝狎矧殓à篦轶璀篝狎ｔ狎珞灬礅溽ī祜徜泔眇殪邃骝镯痫螋镳孱怡翦鲥泗矧轭瘐舡痫螋К泔眇殪邃泔溴┅┅┅┅秕麴豸骖ㄡ痧禊磲脲怙雉骈戾狃瓠怙雉Жㄡ痧孱怙雉骈戾螋扉怏雉桢颦扉怏扉篝秕麴豸骖┅ㄣ镳骈戾矬檫珏暨屮邈豸徕戾唣狒瑭秕麴豸骖┅郇泔眇镱孱舂扉怛狎箦趱ｆ扉怃轵螋扉怏蝈箫祧瀛黹篌轭绛扉怏翎蜱弭豉疱螋扉怏ㄤ锃泔眇殪箫躜沐骖秕麴豸骖ｆ翎蜱弭豉疱┅箬秣骈戾翎蜱弭豉疱ｆｆ螋扉怏Ж箫躜沐骖┹郇扉铍邃扉怛狎箦趱ｆ扉怃轵螋扉怏戾舄ㄛ黹篌轭ㄤ锃泔眇殪箫躜沐骖秕麴豸骖ｆ翎蜱弭豉疱┹垲蟓雉桢颦扉怏蝈眇篦轶璀扉怛狎骈戾蝈箫祧瀛黹篌轭绛扉怏ъ轭脲螋扉怏黹篌轭绌┹垲蟓螋扉怏蝈眇篦轶璀扉怛狎骈戾螋扉怏┹坭狍桠犷戾ㄛ轲镳孱忾钺蝙骈戾麸蝈徜箫躜沐骖┹镱屮轸ㄣ祜箦痫螋轲戾ㄛ孱ㄧ弭箫躜沐镦骟弭轲┹ㄡ钿孱癌ㄢ彗轭ㄦ殪瀛痫箝糸镱轲癌ｔㄧ弭怡翦鲥泗矧轲孱洎┅┅埕眇繇瓠骈戾钺礤秕麴豸骖┹坶镳孱忾钺蝙骈戾麸蝈徜秕麴豸骖┹埏镳孱骈戾繇ǐ线滓衔藤线靡帕线砸瘴茅ｏ贩р轭狎秕麴豸┹ㄤ彐轭ㄣ戾犷躔ㄣ祜箦痫螋轲ㄣ祜箦痫螋镳┅磲翥ㄣ狒汨箬秣骈戾翎蜱弭豉疱ｆｆ铙螋扉怏铙雉桢颦扉怏箫躜沐骖瘐舡怡翦鲥泗矧镳矧栳箬忉铉篝蜷铉觉翩！躞虔忾畀孱篦轶柢睥┅ㄣ镳麸痫螋镳ㄡ痧孱铙螋扉怏铙雉桢颦扉怏┅ㄣ镳轲镳┅郏ㄅ厣蝈狍镱ㄣ戾犷躔蝽繇皓蜥轶蝈狍镱┹郜ㄣ戾犷躔蝈钺礤疳翳繇秕麴豸骖┹┅荸┹