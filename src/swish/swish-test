#! /usr/bin/env swish

;;; Copyright 2018 Beckman Coulter, Inc.
;;;
;;; Permission is hereby granted, free of charge, to any person
;;; obtaining a copy of this software and associated documentation
;;; files (the "Software"), to deal in the Software without
;;; restriction, including without limitation the rights to use, copy,
;;; modify, merge, publish, distribute, sublicense, and/or sell copies
;;; of the Software, and to permit persons to whom the Software is
;;; furnished to do so, subject to the following conditions:
;;;
;;; The above copyright notice and this permission notice shall be
;;; included in all copies or substantial portions of the Software.
;;;
;;; THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
;;; EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
;;; MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
;;; NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
;;; HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
;;; WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
;;; OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
;;; DEALINGS IN THE SOFTWARE.

(define who (path-last (car (command-line))))
(define (fail fmt . args) (apply errorf who fmt args))

(define help-sections '(all details examples))

(define shared-cli
  (cli-specs
   ;; -L and -s are allowed in testing and REPL
   [libdirs -L (list "<libdir>") "add <libdir> to library-directories"]
   [srcdirs -s (list "<srcdir>") "add <srcdir> to source-directories"]
   [help -h --help (list "[<section>]" ...)
    (format "display help, <section>={狺撄}" help-sections)
    (usage hide)]
   [version --version bool "print version information"]))

(define test-only-cli
  (cli-specs
   [incl-tags --tag (list "<tag>") "run only the tests with this tag"]
   [excl-tags --not (list "<tag>") "exclude tests with this tag"]
   [progress --progress (string "<mode>") "<mode>={test|suite|none}"]
   [test-run --test-run (string "<UUID>")
    "use the specified <UUID> to identify the test run instead of generating one"]
   [specs (list . "<spec>") "directory | suite [{test | -t test} ...]"]))

(define test-and-report-cli
  (cli-specs
   [load-prof --load-profile (list "<file>" "<file>" ...)
    "load the specified profile(s)"]
   [save-prof --save-profile (string "<file>")
    "save profile data to specified file"]
   [report --report (string "<file>")
    "write report to <file> in format determined by extension"]
   [coverage --coverage (string "<file>") "write coverage report to <file>"]
   [exclude --exclude (list "<glob>")
    "exclude these files from coverage report"]
   [include --include (list "<glob>") "override exclude for coverage report"]))

(define report-only-cli
  (cli-specs
   [harvest --harvest (list "<from>" "<from>" ...)
    "load mat results from the specified files and directories"]
   [load-results --load-results (string "<file>")
    "load harvested mat results from <file>"
    (conflicts '(harvest))]))

(define testing-cli
  (append shared-cli test-only-cli test-and-report-cli))

(define repl-cli
  (cli-specs
   [repl --repl bool "start a repl" (usage show req)]
   [files (list "<file>" ...) "load remaining arguments"]))

(define any-cli (append testing-cli report-only-cli repl-cli))

(define swish (osi_get_executable_path))
(define swish-libdir (path-parent swish))
(library-directories
 (cons (path-combine swish-libdir "lib")
   (library-directories)))

(define (wrap indent . texts)
  (wrap-text (current-output-port)
    (- (help-wrap-width) indent) indent indent (join texts #\space)))

(define report-formats '(("json" . json) ("html" . html) ("htm" . html)))

(define (check-report-format report-fn key)
  (when (and report-fn (not (assoc (path-extension report-fn) report-formats)))
    (fail
     (oxford-comma
      "cannot determine output format from a a, expected 幄矧 extension")
     (option-named key)
     report-fn
     (map car report-formats))))

(define-syntax foreach
  (syntax-rules ()
    [(_ ([var ls] ...) body0 body1 ...)
     (for-each (lambda (var ...) body0 body1 ...) ls ...)]))

(define-syntax example
  (syntax-rules ()
    [(_ (call ...) text ...)
     (begin
       (wrap 2 call ... "\n")
       (wrap 4 text ... "\n"))]))

(define-syntax any-sections
  (syntax-rules ()
    [(_ requested [(key ...) body ...] ...)
     (let ([sections requested])
       (define thunks
         (remq #f
           (list
            (and (ormap (lambda (x) (memq x sections)) '(key ...))
                 (lambda () body ...))
            ...)))
       (do ([ps thunks (cdr ps)] [sep "" "\n"]) ((null? ps))
         (display sep)
         ((car ps))))]))

(define (usage short? sections ht)
  (define selected
    (cond
     [(pair? sections) sections]
     [short? '(usage)]
     [else '(usage help)]))
  (define supported-formats
    (let ([ht (make-hashtable string-hash string=?)])
      (foreach ([fmt report-formats])
        (match fmt
          [(,ext . ,type)
           (hashtable-update! ht (symbol->string type)
             (lambda (prev) (cons ext prev))
             '())]))
      (format "@?." (oxford-comma "a" " and ")
        (map (lambda (fmt)
               (format (oxford-comma "利④彳矧)}")
                 fmt))
          (vector->list
           (vector-sort (lambda (a b) (string<? (car a) (car b)))
             (hashtable-cells ht)))))))
  (any-sections selected
    [(all usage)
     (display-usage "Usage:" who testing-cli)
     (display-usage "   or:" who (append shared-cli repl-cli))]
    [(all help)
     (when ht (hashtable-delete! ht 'help))
     (display-options shared-cli ht)
     (printf "\n  Test-only options:\n")
     (display-options test-only-cli ht)
     (printf "\n  Test and report options:\n")
     (display-options test-and-report-cli ht)
     (printf "\n  Report-only options:\n")
     (display-options report-only-cli ht)
     (printf "\n  REPL options:\n")
     (display-options repl-cli ht)]
    [(all details)
     (wrap 0
       "By default, " who " runs all tests in the specified test suites."
       "To run a limited set of tests, specify a suite or a suite and test"
       "or use --tag or --not to filter tests based on tags.\n"
       "\n"
       "Test suites are files with a \".ms\" or \".ss\" extension listed"
       "explicitly on the command line or found by recursively searching"
       "the specified directories."
       "Files with a \".ms\" extension are expected to contain tests,"
       "called mats, defined via the mat macro or the add-mat procedure"
       "exported by the (swish mat) library."
       "Files with a \".ss\" extension may contain mats following the"
       "\"#!eof mats\" tokens.\n"
       "\n"
       "If --report <file> is specified, " who " writes a test report to that file"
       "in a format determined by the file extension."
       "Supported formats for the report are:" supported-formats
       "If --coverage <file> is specified, " who " writes an HTML coverage report"
       "to that file."
       "The glob arguments to --include and --exclude should be quoted to prevent"
       "expansion by the shell. Within a glob pattern, ** and * differ in that the"
       "former will match path-separator characters while the latter will not."
       "\n")]
    [(all examples)
     (printf "Examples:\n")
     (newline)
     (example (who "--progress suite --report results.html .")
       "Run all tests found in the current directory and its subdirectories."
       "Echo suite-level progress output to the console and write detailed results"
       "to results.html, overwriting the file if it exists.\n")
     (example (who "--progress suite --report results.json .")
       "As above, but write results in JSON format rather than HTML.\n")
     (example (who "--harvest src --report results.json")
       "Harvest test results from \"*.mo\" files found under the src"
       "directory and write the results to results.json in JSON format,"
       "overwriting the file if it exists.\n")
     (example (who "--load-results results.json --report results.html")
       "Generate an HTML report form a JSON report file,"
       "overwriting results.html if it exists.\n")
     (example (who "--save-profile prof.dat src")
       "Save profile data to prof.dat while running all tests found"
       "under the src directory, overwriting prof.dat if it exists.\n")
     (example (who "--load-profile p1.dat p2.dat --save-profile both.prof")
       "Load profile data from p1.dat and p2.dat and save to both.prof.\n")
     (example (who "-s src --load-profile p1 p2 --coverage ./cov/summary.html")
       "Load profile data from p1 and p2 and generate a coverage report"
       "in ./cov/summary.html, adding \"src\" to the set of directories"
       "searched for source files referenced in the profile.\n")
     (example (who "src/foo.ms")
       "run all tests in ./src/foo.ms\n")
     (example (who "src/foo.ms t1 t2 t3 src/bar.ms")
       "run tests t1, t2, and t3 from ./src/foo.ms and all tests from src/bar.ms\n")
     (example (who " --tag fast --not regression src web")
       "run only the tests under src and web whose mat tags include fast,"
       "but not regression.")])
  (let ([invalid (fold-right remq sections help-sections)])
    (unless (null? invalid)
      (fail "unrecognized help sectionp:狺戾铉翳轭鲠扉洎轭鲠扉洎┅ㄥ轸癌ㄤ彐轭疳蝮瀛扉怛狎扉猢疳蜥礤翦蜷ㄛ扉怛狎溟蝈泗矧殄扉廨扉怛狎溟蝈泗矧殄螬┅ㄤ彐轭ㄦ轭洵骈戾疳翳屮翦铙轱铙ㄤ彐轭ㄣ镯忾铄疳翳骖ㄩㄥ聃犰疳翳骖疳翳泔礅轭疳翳骖┅戾箦狎汨ㄛ疳翳疳翳坭轸Ж┹磲翥ㄣ狒汨扉篝溟蝈泗矧疳翳┅郏ㄅ厣蝈狍镱栝趔郜骘躅ㄦ镬洵戾骠灬礅溽ㄨ轸孱趄磲翥孱趄郇骖滥梢盼赃纳药箦狎汨ㄣ镯忾铄疳翳骖栝趔┹郇骖滥梢盼赃粕膛ㄩ礤礅弪疳翳屮翦铙轱骖屮翦铙轱铙ㄣ镱ㄣ镯忾铄疳翳骖栝趔栝趔┹郜栝趔荸换铒骘祆秣轭簌盱轭塍栝趔骘躅洎荸┅ㄩ眇矧篦轶磲舂篦轶痱镦殪濠篦轶翦篝轭绌换屮疳钿麸痱镢邃躜翳狒蝈趱蝾泔铘孱忮赭邋孱沆矬邃换忪镢氕泔眄孱溴扉黹翦蝮狍篝蜷铉ㄤ彐轭瀛簌铘狲ㄥ趄徙舡忪镢氕泔眄孱戾ㄛ犷铒翎糸镱簌铘狲踞铑雉狒轱┹ㄡ篌弪犷铒翎糸镱戾舄ㄛ篁ㄡ铑雉狒轱瞽箫躜沐犷铒翎糸镱┹垅骛箫躜沐镡赍泗怄篁悌坼骛箫躜沐镡赍泗彐篁悌垧狒箫躜沐骈戾溴筱蜷痿矧疳翳箫躜沐镡赍泗箧篁悌┹｀灬礅溽ī戾ㄛ豸娓倔趄轭蝈徜骈戾，疳翳┅荸ㄤ彐轭筱犷溟痱弼戾ㄛ篝蜷铉蝈椹垲屮ǐ溟颟荸躅戾篌铄，彐皓ㄥ蝌矧у趄徙舡忪镢氕泔眄孱㈠疱泗邃麸骈钿｜轭幄螬ㄩㄡ钿ㄣ栳蚪＼ㄥ聆痱弼＼）铄筱犷铄溟悌┅篚怏趄轭筱犷，怄ｆ筱犷，彐ｆ┅┅┅ㄤ彐轭ㄨ繇飙蝈痫螋骈戾钺礤磲舡溽翎ㄤ彐轭牦泔溴è屮趄徙舡忪镢氕泔眄孱｜骢钽糸镱弩汜疱若盱翦舂鲠磲ЕШЕ犴鸹КЪШЕ祠户ЬШЕ玺户БШЕ聃雉户БЕ０彻户蝈趱蝾翦舢蝈痨徙濞郐季л绗骄磲疔磔┗戾桢徜弪㈨弩筢珏⒑Ⅲ篝狒螈⑩翦螈⑩翦螈沭酡沭酡㈢悱怡翦螈⑶怡翦螈㈢悱泔躅簪敲㈢悱沭酡⑶沭酡㈢悱蝈犰⒑⑶蝈犰Ⅱ遽膦Ⅱ遽膦Ⅲ翎汶⒑Ⅲ蹰翦⒑泔眇戾翦洧趄蹂Ⅳ弩舡骈戾⒑⒂蹰翦Ⅳ徵螈圯Ⅳ弩簪⑽犴澧Ⅳ疱⒑⒁弩蹯簪骢钽糸镱蝈钿弪湾翎礤翎殒ā礤翎栾篝钺礤蝈趱蝾Ё戾轭骘礤翎郄箫骠麽蝈轭骘л鲠脲圯骘脲轭轭骘脲螽瘐箬脲┗脲螽箫螋è岈猢骄猢蝈趱蝾嗉溟沆狍蠼Ⅲ蹰翦礤翎⒕俭疳沆狍蠼溽翦⒕礤翎溽翦⒖架箴犷俭疳沆狍蠼㈣矬纛犴澧兢礤翎郄栾篝钺礤л架箴犷俭疳沆狍蠼㈨徙栝铄豉疱⒕礤翎郄磲汨轭瀛豉疱л架箴犷脲螽磲皎脲骄嗉溟沆狍蠼痱镤蹉簪炯箴犷沆狍蠼痱镤蹉舡钺礤⒕弩汜疱若盱ㄩ铈镗脲蒇ю蝻漉泗钺礤л架箴犷俭疳沆狍蠼Ⅵ弪箝镱⒕弩汜疱若盱ㄩ铈镗脲蒇鲥蝮轱瞌荸架箴犷间轹沆狍蠼Ⅱ弼轶轱睥兢弩汜疱若盱ㄩ铈镗脲蒇蝈鲩箝镱л架溟鼍架溟鼍喋觑轭ěЗ架溟鼍嗷鲠蝈篚祠圯鲠箬秣郁狒轶糸泱戾祜汜戾铄深綮熙礅弪骑蝽狒ī蝈箫祧邃橡糸镱蟥┊祜汜戾戾骘蝽狒翦铄深綮熙礅弪骑蝽狒祜汜戾篝戾т邈轫犰К黹铋眭砥蜥泗轱钅殓轸蠛超磲轫蹴乞徙糸镱拈玳趔┗骢钽糸镱蝈钿弪孽蜥糸镱ㄤ躜狒轱瞟蝈趱蝾豉疱镦ㄤ躜狒轱瞟浇ь蹴忮颛骘蝽狒翦虍骘蝽狒ㄤ躜狒轱瞟漉蜥糸镱骢钽糸镱蝈钿弪芋翎趔篝狒螬蝈趱蝾箬秣郁狒轶糸泱汨邈脲洎嗉翡炯溟沆狍蠼Ⅱ弩蹯舡篌翎趔篌翎趔沭酡兢蝈钿弪孽蜥糸镱篝狒螽沭酴架溟鼍架翡剪渚间轹沆狍蠼Ⅱ弩蹯舡篌翎趔篌翎趔蝈犰⒕蝈钿弪孽蜥糸镱篝狒螽蝈犰架溟鼍架翡剪渚间轹沆狍蠼Ⅱ弩蹯舡篌翎趔篌翎趔怡翦螈兢篝狒螽怡翦簖架溟鼍架翡剪渚间轹沆狍蠼Ⅱ弩蹯舡篌翎趔篌翎趔玢泔躅簪兢篝狒筵㈢悱泔躅簪蔟架溟鼍架翡剪渚间轹沆狍蠼Ⅱ弩蹯舡篌翎趔篌翎趔玢沭酡兢蝈钿弪孽蜥糸镱篝狒筵㈢悱沭酡荸架溟鼍架翡剪渚间轹沆狍蠼Ⅱ弩蹯舡篌翎趔篌翎趔玢蝈犰⒕蝈钿弪孽蜥糸镱篝狒筵㈢悱蝈犰⑤架溟鼍架翡剪渚间轹沆狍蠼Ⅱ弩蹯舡篌翎趔篌翎趔玢怡翦螈兢篝狒筵㈢悱怡翦螈蔟架溟鼍架翡距Ъ翡泔祗疳罱⒎⒕架翡晶骢钽糸镱蝈钿弪吁眄狎ㄤ狒岍鲠篚眄狎疳篌艾箅轲艾驷殪艾轭泔眇戾翦溽翎骘蚺徙瑷篚轸骄篚轸瀹蝈篚祠螽骘蚺徙瑷骄篚眄狎垓豉疱暴┗溽翎骘蚺徙瑷篚轸骄篚眄狎轭泔眇戾翦篚轸遨ы弭岘溽翎л泔眇戾翦暴戾轭泔眇戾翦篚眄狎轭泔眇戾翦俭疳沆狍蠼㈤钽镯痨弭澧鲸篚眄狎轭泔眇戾翦篚轸弩轭泔眇戾翦┘墀箴犷距驷祗寤戾箅轲疱篚眄狎箅轲箅轲疱篚眄狎箅轲┼驷祗寤殒篚眄狎驷殪蝈趱蝾嗉溟沆狍蠼Ⅲ蹴磲蝙驷殪⒕漆殪邃篚眄狎驷殪镦篚眄狎驷殪篚眄狎疳篌翦篝螭箅轲疱潼Ё轭泔眇戾翦Ё架溟鼍嗷殒ㄩ钽镯痨弭濠蝈趱蝾嗉溟沆狍蠼Ⅲ蹴磲蝙疳篌⒕疳篌邃篚眄狎疳篌翦篝螭箅轲疱潼Ё轭泔眇戾翦架溟鼍嗷殒箅轲疱洎蝈趱蝾嗉溟沆狍蠼Ⅲ蹴磲蝙疳篌⒕疳篌邃篚眄狎疳篌翦篝螭箅轲疱潺架溟鼍嗷殒篚眄狎疳篌浇癌蝈趱蝾嗉溟沆狍蠼Ⅲ蹴磲蝙疳篌⒕物翦篝蝓町架溟鼍嗷蝈趱蝾嗉溟沆狍蠼Ⅲ蹴磲蝙疳篌⒕辛佑拍犰篚眄狎疳篌翦篝螽架溟鼍嗷戾痱弼吁轸驷祗寤戾痱弼吁轸逋弭Ё骢钽糸镱蝈钿弪吁轸濞颟戾漉痱弼吁轸浇虍篚轸濠痱弼吁轸虍篚轸寤殒ā漉皓痱弼吁轸逋弭蝈钿弪湾翎虍篚轸濠蝈趱蝾嗉翡沆狍蠼Ⅲ蹰翦漉т躔扉汜翦Ё⒕间轹沆狍蠼Ⅲ蹰翦钺礤虍篚轸瀹泔眇戾翦Ёч钽镯痨弭濮⒕弩汜疱若盱虍篚轸遨翦篝骈戾л痱弼吁轸逋弭猃架溟鼍架翡距骢钽糸镱蝈钿弪吾礤颟殒ā虍翦篝蝈趱蝾嗉翡炯墀翡距蝈趱蝾嗉翡间轹沆狍蠼Ⅱ弩蹯舡轭骘⒕俭疳沆狍蠼Ⅱ弩蹯舡钺礤⒕弩汜疱若盱虍翦篝架箴犷俭疳沆狍蠼Ⅱ弩蹯舡翎珞⒕虍翎珞箫螋è岈猢骄猢磲皎弩汜疱若盱┊觑轭ěЗ架箴犷架溟鼍架翡距骢钽糸镱蝈钿弪赠疱颟蝈趱蝾嗉翡沆狍蠼Ⅱ弩蹯舡豉疱⒕间轹沆狍蠼Ⅱ弩蹯舡虍豉疱⒕弩汜疱若盱虍豉疱架溟鼍架翡距骢钽糸镱蝈钿弪腻翎殪蟥颟蝈趱蝾虍礤篌徵虍篝徙氅嗉翡泔祗疳罱⒎⒕间轹沆狍蠼Ⅱ弩蹯舡弪蝻颌间轹沆狍蠼Ⅱ弩蹯舡礤篌徵澧兢弩汜疱若盱虍礤篌徵濠架溟鼍间轹沆狍蠼Ⅱ弩蹯舡篝徙擘兢弩汜疱若盱虍篝徙氅架溟鼍架溟鼍架翡距ě疳篌浇虍豉疱б弩蹯臾浇虍豉疱蝈钿弪芋翎趔虍篌翎趔Ъ翡泔祗疳罱⒎⒕架翡晶骢钽糸镱蝈钿弪义篚祠颥殇蝈趱蝾嗉趄殇舰殇⒕蝈钿弪吁轸濞颟蝈钿弪吾礤颟蝈钿弪赠疱颟蝈钿弪腻翎殪蟥颟架趄距戾矧溴蜷铉圯骢钽糸镱泔眇狎逡弩蹯趔虮虿蝈趱蝾矧溴蜷铉蝈漉沐议玷舁鲥蜾殂衄矧溴颟骄鲥蜾殂矧溴虍泔眇狎濞虮虿矧溴虍轭鲥螋暴癌骢钽糸镱泔眇狎逵趄轭绋珏趑弪蝈趱蝾虮虿骄戾霰珏趑弪虮Ё戾霾珏趑弪虿Щ殒霰霾蝈趱蝾被殒霰霾蝈趱蝾被蝈趱蝾盎骢钽糸镱泔眇狎逦蹴弪殂ㄧ弭翦颟蝈趱蝾虮虿骄珏趑弪虮珏趑弪虿┗骢钽糸镱箦粲矧舁泔飑戾栝矧溴蜷铉骈钿骄泔浇泔飑殒ㄨ轸矧溴蜷铉箴扉沐矧溴蜷铉轭溴湘ㄨ轸┈暴屐箦栝殒ㄨ轸轭鲥螋蝈趱蝾栝舢轭鲥螋栝舢栳笙黝序镳弪豉ě轭鲥螋З栝舢泔泔旎篦轸汨ㄣ镬汜箦в蹰翦Ш栝舢沆狍篚轸瀛钺礤Щ栝舢泔眇狎泔眇狎逵趄轭绋骄虍篚轸遨翦篝骈戾л┗怛遽牖汜箦吾礤Ш栝舢沆狍蝈篚祠钺礤Щ栝舢泔眇狎泔眇狎逵趄轭绋骄虍翦篝┗怛遽牖汜箦б弩蹯臾栝舢沆狍蝈篚祠义篚祠Щ栝舢泔眇狎泔眇狎逵趄轭绋骄虍豉疱┗怛遽牖汜箦с瘐Ш汜箦蝈犰Ш汜箦р翦螫栝舢沆狍囿篝狒蟓泔忑嗷栝舢泔眇狎泔眇狎逦蹴弪殂骄虍篌翎趔Ζ虍篌翎趔坫镬荸怛遽牖汜箦В敲Ш栝舢沆狍囿篝狒蟓玢泔躅羿栝舢泔眇狎泔眇狎逦蹴弪殂骄虍篌翎趔Ζ虍篌翎趔郄玢泔躅臾荸怛遽牖汜箦敲沭酾栝舢沆狍囿篝狒蟓玢沭踵栝舢泔眇狎泔眇狎逦蹴弪殂骄虍篌翎趔Ζ虍篌翎趔郄玢沭酾荸怛遽牖汜箦敲蝈犰Ш栝舢沆狍囿篝狒蟓玢蝈犰嗷栝舢泔眇狎泔眇狎逦蹴弪殂骄虍篌翎趔Ζ虍篌翎趔郄玢蝈犰л┗怛遽牖汜箦敲怡翦螫栝舢沆狍囿篝狒蟓玢怡翦筻栝舢泔眇狎泔眇狎逦蹴弪殂骄虍篌翎趔Ζ虍篌翎趔郄玢怡翦螫荸怛遽牖殒ㄨ轸泔眇狎濠矧溴蜷铉瘐箬ㄨ轸┗骢钽糸镱蝈钿弪ī戾泔铘孱滹沲礤铘珏襞戾礤铘蛮射ě泔铘孱臾┗戾篝戾箬邋滹沲礤铘篝戾予邋趔郾莼殒篝戾箬邋舢秣铄蛭镤瀹殇浇п泗轹彖遽溴蝮З麒殪篝戾箬邋舢泱笠蹯弩戾铉翳癌篝戾箬邋舢溴戾翦阴戾ò┗矧溴蜷铉骘蚺徙瑷矧溴骄篝戾箬邋舢轭箦螋阴戾ㄠｔ徕戾桢徜弪矧溴虍沆狍簖横骠弪疳滗轭绛戾骠驳屙骒镝艉蜷玷艋泔铘孱艉矧溴虍轭鲥螋к醪碘悃к醪碘钵⒒喱篝戾箬邋舢泱笠蹯弩戾铉翳┅蝈篚祠螽箫螋ㄣ镯疳蝈义篚祠螬泔铘孱舢轭铄蛉酝蝈钿弪义篚祠ㄨ遽溴颥翎忪彖遽溴颛蝈篚祠螽磲皎蝈钿弪义篚祠┊觑轭ěЗ戾滹沲礤铘珏襞戾礤铘蛮射ě翎忪彖遽溴颛┗镱沆殂骄箦粲矧舁瀹翎蜱弭轭铄蛉酝坍趄轫ī┗蝈钿弪ī滹沲礤铘徜渑鲥铘涕篝孱弪ě南兔镱翦铘田徜邃К骢钽糸镱ㄥ鲥铘溽翎骘蚺徙瑷篚轸骄戾礤翎篚轸遨ы弭岘溽翎л戾蝮篚轸瀹蝈篚祠圯殒ā礤翎泔眇戾翦Ζ浇蝮戾铉翳蝮瘐箬豉疱Э┗蝮骘蚺徙瑷骄蜊篚轸濮礤翎蝈篚祠螽瘐箬颟┗┗箬秣郁狒轶糸泱滹沲礤铘珏襞戾礤铘蛮射ě箬秣郁狒轶糸泱З箬秣郁狒轶糸泱汨邈脲驷祗寤箬秣郁狒轶糸泱镱沆殂弼孱骄蝈钿弪ī戾篚眄狎滹沲礤铘珏襞戾礤铘蛮射ě篚眄狎З篚眄狎轭铄蛉酝蝈钿弪吁眄狎ㄤ狒岍箦粲矧舁吾礤З箦粲矧舁в蹰翦З殒ā蝈篚祠螽弼弪骄ю狍螫浇虍豉疱箅轲浇虍豉疱┅箦粲矧舁б弩蹯臾┗蝈钿弪ī┗）┅戾ㄛ镳镳孱骈戾麸蝈痨徙骈戾钺礤┹镱屮轸ㄣ祜箦痫螋镳ㄨ繇飙倔趄轭镳啜梏盱ㄨ遽礤翎ㄣ栳蝮弭⒄云涪┅糸綮⒃弩义篚祠螈换箦疳蜥翦筱蜷痿翎麸桢祓狨麸磲翦翦篝疳蝮秕麴豸筱蜷痿ㄦ矧磲Ⅵ狎溽翎峄牦镱猴怅邈舡倔趄轭磲舡溽翎┅筱蜷痿牦泔溴篝戾⑩镤翎忪彖遽溴蜩彘玷艉碑驳蝈砘磲蜱轭鏖漪韬答磲蜱轭鲠颞磲蜱轭鏖漪瑭桢殓梏汜煦ū鞍鲨勃鲠颞磲蜱轭鏖漪瑭┗溟箴灬珧殇珧殇翦眇灬翦蝻黧狨麸辨蚧秭弪骒秣栝滗孱积桢徜弪忉汶珧秕钿扉玷翮蜥磲蜱轭怙趑镯靛ｓ蹴磲蝙骘铘箝搴灬蜱寤篚眄狎驷殪泔祜蚝蝈浠篚眄狎疳篌ｃ镱趄镬溟箴灬骒屮犰殓瞽轸屙蠛沐铘弪ｓ栾饔翎糸篝殂痱镤蹉溟箴灬扉篝轸屙磲蜱轭戾骠卞砘溽翦栾篝钺礤磲汨轭瀛豉疱篚轸怙蜾弪麸鸷别箫扉扉玷翮蜥痫箝糸镱蝈灬糸鲥篚轸瀛钺礤篚轸瀛钺礤篚轸瀛礤翎溟箴灬铒铄鲩箝忾扉豉栝滗孱镳徙轸盎骘铘箝搴箜犰旎篚轸瀛钺礤鸿秭弪篚轸瀛礤翎痫箝糸镱徕箫祯翦轭溴被溟箴灬忪镢牖鲩箝忾扉豉鲩箝忪寤镳徙轸被疳滗轭绾卑瘌磲蜱轭麸鸷靛砘鏖漪韬嘲梆忉汶珧秕钿蜱忉ú窗泊艾泊艾暴怙蜾弪蜥溟躞卑瘌漉痨殂狒鲩箝忾扉豉栝滗孱怙蜾弪麸瓠篝戾铒铄轭泔眇戾翦忉汶珧秕钿屐祜骰蝈篚祠轭骘黠蜾怛遽牒怛遽氕犰旎黹瞽鏖漪韬钡鲼磲鏖漪韬驳鲼蝈篚祠钺礤蝈篚祠翎珞侯雉ê屙痿骘铘驷黹禊筢铙骘铘箝搴箜犰旎磲蜱轭戾骠卞砘蝈篚祠疳篌鏖漪韬村砘翦舡趄犷箧矧砗躔疱蜚狍寤泔祜蚝珧邋罨蝈篚祠箅轲鏖漪韬村砘翦舡趄犷箧矧砗躔疱蜚狍寤骘铘篝戾镡扉聃寤蝈篚祠驷殪鏖漪韬村砘翦舡趄犷箧矧砗躔疱蜚狍寤泔祜蚝蝈浠蝈篚祠弪蝻痫箝糸镱蝈灬糸鲥黹瞽鏖漪韬蛋鲼磲鏖漪韬栋鲼蝈篚祠礤篌徵蝈篚祠篝徙牒栾鲥磲桢殓梏卑屙秭弪骒秣狨麸蝈篚祠篝徙牒铒舁鸿秭弪┖铒舁哄眇豉┖忮骘蝈泔铘孱艉堍堍痫箝糸镱徕箫祯翦蜷玷艉梆怙趑镯梆磲蜱轭蜷玷艉靛砘骘铘箝搴灬蜱寤蝈篚祠篝徙骘铘驷黹禊盹铒箴徙寤麒轸瀛箴徙搴痱寤忉汶珧秕钿蜱忉ú档膊艾膊艾辈旦磲桢殓梏卞砘秭弪骒秣栝滗孱蝈篚祠豉疱鏖漪韬靛砘蝈篚祠篌翎趔翦舡犰殓詈蜷玷艋篌翎趔沭鏖漪韬跺砘篌翎趔蝈犰鏖漪韬跺砘篌翎趔怡翦鏖漪韬峰砘篌翎趔玢泔躅鏖漪韬村砘篌翎趔玢沭鏖漪韬跺砘篌翎趔玢蝈犰鏖漪韬跺砘篌翎趔玢怡翦鏖漪韬峰砘鲶泸镬秭弪骒秣狨麸秭弪骒秣栝滗孱磲蜱轭麸鸷鲠颞翎忪彖遽溴蜩彘玷舂鲶泸镬趄烘轵篝汨殪翡怙蜾弪麸瓠篝戾铒铄痫箝糸镱躅箦艋鲶泸镬趄烘轵篝汨殪溟忉汶珧秕钿蜱猕泊惮泊惮泊旦痫箝糸镱徕箫祯翦麸梆磲蜱轭麸鸷汜煦ō鲠颞翎忪彖遽溴蜩彘玷舂┗Ⅳ徕戾翎忪瀛灬秕艉骈邃怙蜾弪泔祆狃箦泔祆狃箦Ⅳ鲥螋殂犰犰殓詈翦舡麸鸹Ⅳ蚝铒舁烘轵篝汨殪洎鸿秭弪忉汶珧秕钿ｆ存存椿Ⅳ浜铒舁红狍舡汨殪洎疳滗轭绛蜷玷艉靛砘篝戾ㄩ⑨泗轹彖遽溴蝮┅┅ㄢ镤篝戾㈡镱舡驷黹禊喉镱矬疳沐虎┅ㄤ轹ㄣ灬篌㈣遽溴颌┅ㄤ轹ㄩⅢ蹴磲蝙┅ㄤ轹ㄩ泔铘蝻祗┅ㄩ铕豸豉疱汨邈脞秫ㄩⅢ栾饔翎糸篝殂螈┅灬忮ㄦ矧Ⅲ栾饔翎糸篝殂螈┅⒂栾郁狒轶糸泱┅ㄤ轹ㄣ灬篌Ⅵ筱蝻祆┅翎忪ㄩ泔铘孱簪┅┅┅┅┅ㄤ彐轭ㄣ镱箫戾篚眄狎磲舡溽翎蝈痫螋轭缈戾舡鲠祯弩ㄛ疳篌驷殪箅轲泔眇戾翦狒翦眇翦洎篚眄狎辁瀛蝈篚祠磲舡溽翎┹麒孱蝈痫螋轭缈痱轭翩⒃弩趔蝓詈嗅篌漆殪与轲筌钴睥ǐ疳篌驷殪疳篌驷殪箅轲┅戾ㄛ轭泔眇戾翦ō狒翦眇翦泔眇戾翦洎荸躅戾篌弪锟轭泔眇戾翦痱轭翩语礤翦篝篚轸妣溟铒泔眇戾翦茴茴轭泔眇戾翦┅┅ㄤ彐轭ㄩ姝屮轶趔骖ㄡ钿蝈珲灬颦骈戾骖骖┅ㄤ彐轭ㄧ弭翦篝骈戾ㄡ钿ㄤ轵邈麸蝙ㄦ轭洵骈戾㈨螈Ⅲ螈┅ㄤ彐轭ㄧ弭翦篝篚轸矧ㄩ姝屮轶趔ㄩ姝屮轶趔篝蜷铉狃疱钿眢┅┅ㄤ彐轭疳翳炬殪瀛躜疳翳ㄤ彐轭筢铋糸疳翳觑轭磲梏麴吼弪沐铘孱泔溴痱彗屮瓠箴扉蝈③苘苘茛疳翳┅┅磲翥痱彗屮瓠磲翥蝈⑥ㄛ岘镰谳憨圮苘墀莰疳翳郇犷汨矧蝈篝篝蜷铉狃疱钿㈡殪搴犷汨矧筢铋糸蝈篝┅郏篝蜷铉狃疱钿㈡殪搴筢铋糸疳翳┅荸ㄤ彐轭ō掘屦矧舡骈戾钺礤骈戾钺礤篝蜷铉狃疱钿骈戾钺礤盹┅ㄤ彐轭ㄥ趄徙舡篚轸弩箴邈螬戾ㄛ梏磲脲栳箬翎忪篝蜷铉栳箬篝蜷铉娇┹ㄤ彐轭ㄡ滗篚轸篚轸濠麒孱磲栳鲥磲趔篚轸濠ㄨ狍梏徕戾躔溽翦梏篚轸灬礅溽镬洎矧镬磲脲栳箬翎忪篝蜷铉栳箬篝蜷铉娇┅ｆ┅戾祓ㄛ箴邈箴邈筝ㄣ镱郇铛祆箴邈螬戾舡鲠祯弩ㄛ脲鲠祗ㄨ狍梏徕戾孱趄殄梏┹鲥泗矧眷轶鲥泗矧磲灬礅溽篚轸翦篝箦舂ㄣ镱篚轸磲篝蜷铉倔礅镬鲥泗矧眷轶ㄨ狍梏徕戾脲翦篝箦舂┅┅脲鲠祗┅┹郇珏舡翦篝骈戾ㄣ狎箴邈螬骄灬礅溽ㄦ殪弩ㄦ矧遽汨徜洵篚轸骈戾螬祓ㄣ潋箴邈螬┅郇珏舡翦篝篚轸ㄣ狎箴邈螬骄灬礅溽篚轸濠ㄡ滗篚轸篚轸濠戾ㄛ趑ㄨ狍梏徕戾蝈梏篚轸ｆ┹ㄤ彐轭ㄡ滗翦篝翦篝ㄨ狍梏徕戾箦簟趑翦篝ｔ┅戾祓ㄛ祗ㄣ潋箴邈螬荸磲翥祗郇祓祗┹郇簪ㄦ衢镳糸镱屮疱泗鲠祯搴簪┹郇簪翦篝蝈篝ㄡ滗翦篝翦篝祓蝈篝┹郇翦篝蝈篝ㄧ踽蜾铒矧ㄤ轵邈麸蝙翦篝ㄧ弭翦篝篚轸翦篝┅┅ㄡ滗翦篝翦篝祓蝈篝┹郜蝈篝祓蝈篝┹┅┅坼祗ㄦ衢㈠疱泗邃溟蝈泗矧矧篚轸搴螈ㄣ狎箴邈螬┹┅┅ㄤ彐轭ㄨ狎鲥篝骝镯戾ㄛ梏磲脲栳箬翎忪篝蜷铉栳箬篝蜷铉娇┹ㄤ彐轭ㄧ弭蝈篚祠骝镯磲翥ㄣ狒汨祜徜蝈篚祠骝镯┅郏ㄅ厣蝈狍镱ㄦ衢汜铑雉祜徜磲蝈篚祠骝镯岷幄骝镯ㄥ轸蝈狍镱惧铉扉箬蝈狍镱┅郜蝈篚祠蝈篚祠筝┅ㄤ彐轭ㄡ滗骝镯ㄩㄤ轵邈麸蝙骝镯ㄦ矧遽汨徜洹ㄦ轭洵骈戾骝镯㈨铫┅ㄨ狍梏徕戾箦簟梏骝镯ｔ┅ㄦ矧遽汨徜洹骝镯鲥泗矧眷轶鲥泗矧磲珏舡蝈篚祠ㄨ狍梏徕戾脲梏┅┅ㄤ彐轭镳糸镱钺礤钺礤ㄦ矧磲舡箴邈矧ㄦ轭灬礅溽ㄥ聃犰钺礤坚蜱箴邈钺礤┅犷沆椹ㄦ衢③轭翦蝾犰铒镳糸镱钺礤螈钺礤┅Ж矧祜铉箬矧狎珞┅ㄤ彐轭趄疳蝮濠ㄤ彐轭痱镡戾ｆㄤ彐轭蝈痨镳疳蝮瀛泔眄犷洵扉铄狎珲礤铘ㄡ痧孱蝈痨沆翦篝轭绛沆椹换孱篚蝈蝈痨ф殪弩镳糸镱泔礤忮骘蝈翦篝轭绉箴邈镳糸镱ㄣ镯磲钿扉铄狎珲礤铘螬灬礅溽躅戾篌痱镡戾箦簟痱镡戾┅┅ㄩ蝈痨镳蝈痨ㄩ痱镡戾ㄡ痧禊驷殪痱镡戾愆蝈痨镳舂疳蝮瀛泔眄犷洵扉铄狎珲礤铘ㄡ痧孱翦篝轭绛沆蝈痫螋镱禊沆椹┅ㄤ彐轭镳趄疳蝮濠ㄣ镱郇镳篁沅轵螬骄灬礅溽篁沅轵螬箫躜沐溟蝈泗矧殄ㄡ痧孱篁沅轵箫躜沐溟蝈泗矧殄螬┅┹扉怛狎溟蝈泗矧殄ㄦ镬洵蜷玷灬礅溽徙悌ㄡ痧孱疳蝮瀛扉怛狎徙悌扉怛狎溟蝈泗矧殄螬矧镳ъ殁溟蝮Ж┅┅ㄣ镱郇弪锟ㄨ狍梏徕戾箝镳舂┅躞徵ｔЖｆ┹郇镳ц屐皓骄灬礅溽箦泗轱铙躞徵ｆ磲篝蜷铉倔礅镬箦泗轱铙镳舂┅郇镳鲥蝮轱瞟痱轭翩皱蝮轱岍茴麒箫骠麽蝈鲥蝮轱篦轶瑭箫骠麽蝈蝈鲩箝镱篦轶瑭┹郇栳箬翎忪瀛蝈镳舂蝈痨ｆ戾ㄛ殓铒蝈蝈眈ｆ磲灬礅溽ㄡ钿铒礤眈箬狎邃沆椹镳坚蜱箴邈钺礤┅ㄦ矧磲舡箴邈Ж矧祜铉箬矧舂┅翦篝轭绛沆椹┹麒孱疳轵殓铒蝈洎痱轭翩累社铒蜷铉狺蕃 in a mode\n]" ignored
        (option-named 'repl))))
  (apply (scheme-start) (cons "--" (or (opt 'files) '())))]
 [else
  (let ([incl-tags (map string->symbol (or (opt 'incl-tags) '()))]
        [excl-tags (map string->symbol (or (opt 'excl-tags) '()))]
        [exclude (or (opt 'exclude) '())]
        [include (or (opt 'include) '())]
        [save-prof (opt 'save-prof)]
        [load-prof (opt 'load-prof)]
        [progress (string->symbol (or (opt 'progress) "test"))]
        [report (opt 'report)]
        [coverage (opt 'coverage)]
        [suites (sort (lambda (s1 s2) (string<? (car s1) (car s2)))
                  (extract-suites (or (opt 'specs) '())))])
    (check-report-format report 'report)
    (cond
     [(and load-prof (not (or save-prof coverage)))
      (fail "a requires a or a"
        (option-named 'load-prof)
        (option-named 'save-prof)
        (option-named 'coverage))]
     [(and coverage (not (or load-prof save-prof)))
      (fail "a requires a or a"
        (option-named 'coverage)
        (option-named 'load-prof)
        (option-named 'save-prof))]
     [(and report (not (or (opt 'harvest) (opt 'load-results) (pair? suites))))
      (fail "a requires a or a or a set of tests to run (a)"
        (option-named 'report)
        (option-named 'harvest)
        (option-named 'load-results)
        (option-named 'files))]
     [(and (opt 'harvest) (pair? suites))
      (fail "a conflicts with a"
        (option-named 'harvest)
        (option-named 'files))]
     [(and (opt 'load-results) (pair? suites))
      (fail "a conflicts with a"
        (option-named 'load-results)
        (option-named 'files))])
    (let ([test-files (map car suites)]
          [test-run
           (uuid->string ;; normalize to swish's format
            (cond
             [(opt 'test-run) =>
              (lambda (s)
                (match (catch (string->uuid s))
                  [#(EXIT ,reason)
                   (fail "invalid a UUID a" (option-named 'test-run) s)]
                  [,uuid uuid]))]
             [else (osi_make_uuid)]))])
      (define report-files (map ->report-filename test-files))
      (define status 0)
      (define no-tests '())
      (define full-load-filenames
        (map
         (lambda (load-fn)
           (match (catch (get-real-path load-fn))
             [#(EXIT ,reason)
              (fail "a a: file not found" (option-named 'load-prof) load-fn)]
             [,full-load-fn full-load-fn]))
         (or load-prof '())))
      (define (truncate-profile)
        (match (catch (open-file-to-replace save-prof))
          [#(EXIT ,reason)
           (fail "a a failed (a)" (option-named 'save-prof) save-prof
             (exit-reason->english reason))]
          [,op (close-port op)]))
      (cond
       [(and load-prof save-prof)
        (let ([add-to-profile
               (match (catch (get-real-path save-prof))
                 [#(EXIT ,reason) #f]
                 [,full-save-fn
                  (and (member full-save-fn full-load-filenames) full-save-fn)])])
          (unless add-to-profile (truncate-profile))
          ;; mute the console-event-handler
          (parameterize ([console-error-port (open-output-string)])
            (match-let* ([#(ok ,pid) (profile:start add-to-profile save-prof #t)])
              (foreach ([to-load (map cons full-load-filenames load-prof)])
                (match-let* ([(,full-name . ,user-supplied-name) to-load])
                  (unless (equal? full-name add-to-profile)
                    (match (catch (profile:merge full-name))
                      [ok (void)]
                      [#(EXIT ,reason)
                       (fail "cannot load profile data from a" user-supplied-name)]))))
              (profile:stop))))]
       [save-prof (truncate-profile)])
      (foreach ([suite/test suites] [report-file report-files])
        ($init-mat-output-file report-file (car suite/test) test-run))
      (foreach ([suite/test suites] [report-file report-files])
        (let ([suite (car suite/test)]
              [tests (cdr suite/test)])
          (match (run-test-spec swish
                   (<test-spec> make
                     [test-file suite]
                     [test-run test-run]
                     [report-file report-file]
                     [tests (and (pair? tests) tests)]
                     [incl-tags incl-tags]
                     [excl-tags excl-tags]
                     [profile save-prof]
                     [progress progress]
                     [lib-dirs (library-directories)]
                     [src-dirs (source-directories)]))
            [ran (void)]
            [fail (set! status 1)]
            [skip (set! status 1)]
            [no-tests (set! no-tests (cons suite no-tests))])))
      (let ([summary
             (cond
              [(opt 'load-results) =>
               (lambda (filename)
                 (match (catch (json:bytevector->object (read-file filename)))
                   [#(EXIT ,reason)
                    (fail "cannot load results from a: a" filename
                      (exit-reason->english reason))]
                   [,results results]))]
              [(opt 'harvest) => harvest]
              [else (map load-results (filter file-exists? report-files))])])
        (when report
          (match (assoc (path-extension report) report-formats)
            [(,_ . json)
             (let ([op (open-file-to-replace report)])
               (on-exit (close-port op)
                 (json:write op summary 0)))]
            [(,_ . html)
             (html-report report summary)
             (printf "see a\n" (path->file-uri (get-real-path report)))]))
        (when coverage
          (if (profile:dump-html (or save-prof load-prof) coverage include exclude)
              (printf "see a\n" (path->file-uri (get-real-path coverage)))
              (printf "no profile to dump\n")))
        (console-summary summary (or report coverage (opt 'load-results) (opt 'harvest)))
        (match (filter (lambda (fn) (string=? "ms" (path-extension fn))) no-tests)
          [() (exit status)]
          [,expected-tests
           (unless (eq? progress 'none)
             (printf "No tests found in茴狺茴屮疱泗邃翦篝螬ㄥ轸ㄩ篝狒躞癌篝狒躞畅┹┅┅荸