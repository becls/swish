#!/usr/bin/env swish

(define-tuple <args> boot-files libdirs rt-libs source-fn output-fn shebang? libs-visible? verbose?)

(define swish-lib?
  (let ([libs (filter (lambda (lib) (match lib [(swish . ,_) #t] [,_ #f])) (library-list))])
    (lambda (lib)
      (member lib libs))))

(define swish-libdir (path-parent (osi_get_executable_path)))

(define (system-libdir swish-wpo?)
  (path-combine swish-libdir (if swish-wpo? "wpo" "lib")))

(define swish-library-filename
  (get-real-path (path-combine swish-libdir "swish.library")))

(define (library-setup swish-wpo? verbose? libdirs)
  (library-directories (cons (system-libdir swish-wpo?) libdirs))
  (when verbose?
    (printf "Library directories:\n筌铪扉怛狎溟蝈泗矧殄螬┅ㄤ彐轭麒疳翳灬篝ㄣ狎ㄣ镯磲钿扉铄┅┅ㄤ彐轭ㄦ衢骓狎珞ㄡ痧禊弪蝻蜴麒骓狎珞┅ㄤ彐轭ㄤ彐狨祠狎珞坚蜱缶磲脲垅镲舡骈戾Ж┹垤殁溟蝮扉怛狎溟蝈泗矧殄螬垓舡扉怏Ж┹垠秕蜚瀛骖ｆ埏豸瘐舡骖ｆ垠桢忉铉ｔ垤殁蟓鲩箝忪蹇ｆ埚弪怙箦ｆ荸ㄤ彐轭躞徵滹悱豉疱ㄣ狍滹悱豉疱郇犰桢祓痱轭翩⒄筢珏埏痿轱钶箫躜沐骖茴麒铹痱轭翩⑾痿轱铙很睥痱轭翩秕舡骈戾黩轸秕麴豸麸秕舡骈戾茴痱轭翩扉怃轵徜扉怃轵麸扉怛狎溟蝈泗矧殄筌睥痱轭翩怙雉骈戾磲脲篝犷洵犰镱狃痨殂狒轱轭沆蹁轭怙雉骈戾茴痱轭翩扉怏鲩箝忪磲脲轫痫螋邃扉怛狎殄鲩箝忪麸弼犰茴痱轭翩螋扉扉徜泔眇殪邃扉怛狎麸篝犷洵犰镱怙雉骈戾茴痱轭翩孱徕戾鲥蜮矬怩殪秕麴豸茴痱轭翩桢祓箬秣翳轶桢祓茴痱轭翩滹剪疱箬秣滹剪疱窘犰禳桢祓溴翎殪簏屮犴痨弩茴铄黛轭濠荸ㄣ狍滹悱豉疱郇犰溴翎殪螬痱轭翩汜磲脲篝犷洵犰镱狃痨殂狒轱矧扉铍邃狃痨殂狒轱町茴麒铹铄黛轭濠痱轭翩⑸轶箴邈殒殄洮泸遽翦篝犷洵犰镱狃痨殂狒轱钴睥麒铹痱轭翩⑩泔瘗轭翳屮邈豸徕戾麸硷豸骈戾犷泸遽糸铉怙雉茴箫骠麽蝈轭翦蝾犰钺礤痱轭翩㈡殪硷豸骈戾井怙雉泔铘衢铋铉遽汨怙雉骈戾轭矧溴颥犰镱畿睥痱轭翩Ⅶ轸翳扉怛狎殄蝈聃轵邃怡箫躜沐骖犷翳狃痨殂狒轱泔溴茴痱轭翩㈡蝻箫躜沐骖犷翳蝓瞽糸礤扉怛狎殄轭沆蹁邃鲩螋扉猱茴铄黛轭濠痱轭翩⒘篝犷洵犰镱狃痨殂狒轱屮邈豸弩怡很睥痱轭翩碑祜徜轭翳狃痨殂狒轱怙雉骈戾翳孱茴痱轭翩伯轭鲲腴铉翳鲠祯镦翳篦轶璀篝狎疳蜥礤翦蜍睥痱轭翩鏖翳翳泔眄犷洵扉铄狎珲礤铘螽茴痱轭翩⒃桢狃痨殂狒轱怙雉骈戾箬秕熹沲篝镯辁翳篦轶璀篝狎疳蜥礤翦虍茴铄黛轭濠痱轭翩⑸轶镯轸翦洮泸遽翦扉铍邃狃痨殂狒轱町茴麒铹痱轭翩⒃蝓扉铍邃狃痨殂狒轱瞵眭篝忮轭篝犰戾镱翳簌篝屙茴箫骠麽蝈轭翦蝾犰钺礤痱轭翩⒘扉铍邃狃痨殂狒轱屮邈豸弩怡很睥痱轭翩碑祜徜轭翳篝犷溽蜾怙雉骈戾翳孱茴箫骠麽蝈轭翦蝾犰钺礤痱轭翩伯轭鲲腴铉翳溴驷蹯篦轶璀篝狎栳钿戾颥麒殂柢睥痱轭翩钞汜祆翳扉铍邃狃痨殂狒轱鏖翳翳泔眄犷洵扉铄狎珲礤铘螽茴铄黛轭濠荸ㄣ狍滹悱豉疱郇犰屮犴痨弩痱轭翩⑴犴痨弩很睥铄黛轭濠痱轭翩骘疱糸翦骘锂篌茴麒铹痱轭翩怩殪潴篝犷洵犰镱堍骘镘屮邈豸徕戾骝镯堍骘锂篌堍茴痱轭翩躞轭翳筢礤疱糸翦怙雉翳狒篦轶躞弩茴铄黛轭濠痱轭翩骘疱糸翦筱桢礤骘锂篌茴麒铹痱轭翩怩殪潴篝犷洵犰镱堍骘镘屮邈豸徕戾骝镯堍骘锂篌堍茴痱轭翩躞轭翳筢礤疱糸翦怙雉犷筱桢礤怙雉翳狒篦轶躞弩茴痱轭翩ㄩ麇箴邈殒殄镱禊筱桢礤翳蝈篚祠轭骘锂怙雉黠蹯滠睥痱轭翩铒忮趄蹯篝犷洵犰镱瀣箝钽筱桢礤怙雉蝈聃轵弩疱糸翦怙雉┸睥铄黛轭濠痱轭翩骘疱糸翦筱桢礤螋扉篦轶骘锂篌茴麒铹痱轭翩怩殪潴篝犷洵犰镱堍骘镘屮邈豸徕戾骝镯堍骘锂篌堍茴痱轭翩躞轭翳筢礤疱糸翦怙雉犷筱桢礤怙雉翳狒篦轶躞弩茴痱轭翩犷磲脲翳篝犷溽蜾篦轶扉怛狎殄狯衢灬忪狒蝓糸礤箫茴痱轭翩翳狒堍骘镘汜泔眇殪泔溴翳狒躞弩翳矬扉怛狎殄螽茴┹郇桢祓鲲殇┹坼祗ㄦ衢Ⅴ铗邈镧铋邃滹幄滹悱豉疱┹ㄥ轸癌ㄤ彐轭疳蝮瀛扉怛狎扉猢疳蜥礤翦蜷ㄛ扉怛狎溟蝈泗矧殄扉廨扉怛狎溟蝈泗矧殄螬┅ㄤ彐轭瀛簌铘狲磲翥璀蝈聃轵邃簌铘狲蝓戾ī郇狎珞沆狨箦磲翥狎珞郇镳糸镱盹蝈ㄤ彐轭铄邃狎绌ㄦ衢蝈聃轵弩犷狎珲礤铘箦桢祓镳糸镱┅磲翥盹蝈郇铄邃狎绌郇镳糸镱擤ㄧ踽蜾篝狎趔鏖翳镳糸镱┅铄邃狎绌沆狨箦┹┹┅ㄤ彐轭疳蝮瀛狎珞狎珞麒孱铛祆狎珞躞徵ц屐皓戾疳蝮ㄛ狎珞狎珞坩沣ㄤ彐狨祠狎珞┹磲翥狎珞郇徙爿郇桢祓擤躞徵ц屐皓郇滹恽擤磲翥璀蝈聃轵邃狎珞郇滹悱豉疱擤躞徵篝蜷铉倔礅镬滹悱豉疱┅荸郇挞擤磲翥璀蝈聃轵邃狎珞郇扉盹蝈坚蜱缶泔瘗疳蝮盹蝈徙悌垤殁溟蝮ㄡ痧孱疳蝮瀛扉怛狎扉猢扉怃轵螬荸荸郇猗擤磲翥璀蝈聃轵邃狎珞郇怙雉骈戾盹蝈坚蜱缶泔瘗疳蝮盹蝈徙悌垅镲舡骈戾ㄣ镱怙雉骈戾怙雉骈戾螬垠桢忉铉ｆ荸荸郇铫擤磲翥璀蝈聃轵邃狎珞郇秕麴豸骖盹蝈ㄩ坚蜱缶秕麴豸骖徙悌ㄦ衢漉痨殂狒幄秕麴豸骖疳蝮盹蝈坚蜱缶泔瘗徙埏豸瘐舡骖秕麴豸骖荸┅荸郇扉怏鲩箝忪澧盹蝈疳蝮盹蝈坚蜱缶泔瘗徙垤殁蟓鲩箝忪蹇ｔ荸┹郇觫盹蝈疳蝮盹蝈坚蜱缶泔瘗徙埚弪怙箦ｔ荸┹郇螋扉猗擤磲翥璀蝈聃轵邃狎珞郇扉盹蝈坚蜱缶泔瘗疳蝮盹蝈徙悌垓舡扉怏ㄣ镱ㄧ弭蝈犰疳翳蝈箫祧瀛螋扉扉猢螋扉怏┹┹┹郇雉桢躅屮疱泗邃ㄧ踽蜾篝狎趔鏖翳雉桢┅ㄦ衢Ⅴ铄疱泗邃狺狺箦桢祓雉桢躅屮疱泗邃┹郇箫躜沐骖盹蝈ㄩ坚蜱缶箫躜沐骖徙悌ㄦ衢㈠趄轭瘐骈戾钺礤幄箫躜沐骖疳蝮盹蝈坚蜱缶泔瘗徙垠秕蜚瀛骖箫躜沐骖荸┅荸┅换泸遽翦繇骈戾换镱翳筢礤骈戾簌篝屙狍忉箝蟋屐箦蝈钺礤疳翳鏖祆驷殪换鏖翳腩秣屮翦铙轱瞵箝钽泔眇殪瀛麒镬瀛痱镧蜥蝈痨徙弩换屮翦铙轱鏖翳黟ㄤ彐轭繇瓠骈戾钺礤忉箝螬ㄦ矧磲岘扯虍繇稷疳翳蝻雉忉箝螬ㄢ翦鲥泗矧蹰铘蝈矬檫磲脲啧蹰洎ъ轸綮倍┅ㄤ彐轭ㄣ镳轲镳ㄤ彐轭怩骒孱ㄥ痿倍┅ㄤ彐轭怩磲脲怡翦鲥泗矧怩骒孱┅戾沭ī戾ㄛㄧ弭怡翦鲥泗矧睢轲怩怩骒孱┹躅戾篌ㄥ镦镡赍泗瞟瘐舡怡翦鲥泗矧镳怩瞟ㄣ皓┅┅ㄤ彐轭ㄣ镳麸秕麴豸骖轭瘐舡骖换镳孱骈戾狃痨殄盹溴ｏ贩镱禊麒孱泸遽糸铉翳骈戾箫骈蝮蝈盹鲥蝽秕麴豸骖戾ㄛ镳镳孱骈戾秕麴豸骖ǐ线滓衔藤线靡帕冤ｏ贩р轭狎秕麴豸┹镱屮轸ㄣ祜箦痫螋镳ㄦ矧遽汨灬礅溽ㄩ铕豸骖戾ㄛ轲镳孱骈戾轭瘐舡骖线夷衔藤р轭狎轭瘐舂荸镱屮轸ㄣ祜箦痫螋轲ㄣ镳轲镳┅┅轭瘐舡骖┅┅ㄤ彐轭蝽骈戾钺礤ㄣ狒汨蝈盹鲥骈戾骈戾钺礤┅ㄤ彐轭ㄤ锃泔眇殪箫躜沐骖秕麴豸骖扉怏鲩箝忪蹇篦轶璀黟锟戾ㄛ繇繇瓠骈戾钺礤箫躜沐骖┹镱屮轸蝽繇皓ㄣ镯痖戾轫痫螋邃扉怛狎殄ｔㄧ孱弪狒瀛黟锃骈戾ｔㄣ镯痖戾痱镧蜥箫躜沐骖繇皓戾舄ㄛ黟锃骈戾篝蜷铉狃疱钿疳翳蝻雉繇皓黟铫┹垤殁ㄣ镯痖戾麒镬瀛痱镧蜥黟锃骈戾秕麴豸骖扉怏鲩箝忪蹇┹垌轶箝铉扉怏换郁犷洵犰镱狃痨殂狒轱箬秕熹栳鲥骘躅犰蝈聃轵邃铒瞽篦轶扉怛狎殄螽换涉篦轶扉怛狎殄狎轭泔蝠矧狒邃鲩麒镬瀛痱镧蜥镳糸黹狒轱瞵换翳孱麇眭篝犰箫栳鲥骘躅翳翳矬扉怛狎殄螽换腻疱钿孱狃痨殂狒轱铙汜躞篦轶扉怛狎殄轭沆蹁邃轭蝓铘轫瀣换狍汜篝犷洵犰镱狃痨殂狒轱铙翳狒屮痨殂轸禊箴邈殒螋扉篦轶璁ㄩ篦轶璀黟锟扉怏蝈眇篦轶璀扉饪扉怏┅荸蝽黟锃骈戾躅戾篌铛祆黹篌轭绛扉怏痱轭翩⒃桢箦扉怛狎殄眭篝忮痱秭殇邃狒蝓糸礤很铪筌铪黹篌轭绛扉怏┅┅┅ㄤ彐轭怙雉骈戾磲戾ㄛ汜汨ｆ荸灬礅溽ī躅戾篌汜汨箦簟汜汨ㄢ蹰熹怙雉骈戾磲皓┅汜汨濠┅ㄤ彐轭ㄢ蹰熹怙雉骈戾磲皓戾舡鲠祯弩ㄛ麸篝溟骝镯篝滹豸骝镯篝溴蝌矬痖洎箴狩瞽矬痱镢弩矬檫珏暨屮邈豸徕戾唣狒瑭Ж鲥蜮矬澧箦戽┹ㄣ祜箦痫螋麸篝溟瞟戾ㄛ骝镯篝溴蝌ㄢ轭狎觉翩骝镯篝溴蝌┹戾祓ㄛ犰Ж┹戾ㄛ扉铄ㄧ弭扉铄骝镯篝溴蝌┹ㄩㄥ镦镡赍泗扉铄犰祓磲翥痱彗屮瓠磲翥⑥趄轭ó┸墚苘苘镳孱邃茯郡扉铄郇骖ㄣ镱ㄣ镱疳翳灬篝骖骖犰螬郜犰筝┅┅┅┅ㄤ彐轭蝈箫祧瀛怙雉骈戾怙雉ㄣ镱郇蝈珲灬颦骈戾怙雉怙雉郇狍箫怙雉ㄢ镲舡骈戾磲皓骄沅蜉郇狍箫篝蜷铉狃疱钿怙雉怙雉ㄢ镲舡骈戾磲皓骄沅蜉坼祗ㄦ衢汜铑雉蝈箫祧怙雉骈戾幄怙雉┹┅ㄤ彐轭蝈箫祧瀛螋扉螋扉猢ㄣ镱郇蝈珲灬颦骈戾螋扉猢螋扉廨郇羼踽炜螋扉Ⅲ鏖箬篦轶璀扉怛狎骈戾钺礤坼祗ㄦ衢汜铑雉蝈箫祧螋扉螈螋扉猢荸磲翥疳蝮瀛狎珞ㄣ镯磲钿扉铄狎珲礤铘螬坂坚蜱缶垠秕蜚瀛骖ｆ荸ㄦ衢Ⅱ羼蹰蝈箫躜沐骈戾钺礤箦桢祓┹坂坚蜱缶埏豸瘐舡骖ｆ荸ㄦ衢Ⅱ羼蹰蝈秕麴豸骈戾钺礤郗骈戾莼箦桢祓┹坂坚蜱缶怙雉骈戾扉怃轵箫躜沐骖秕麴豸骖箬邂犷缈扉怏鲩箝忪蹇螋扉怏鲥蜮矬蹇ㄤ彐轭篝犷洵犰镱蹇铒铛祆怙雉骈戾螬┅换龄祜汜糸镱镦篦轶簌篝屙黟骈戾镱禊殒麇蝈怩殪溟铉换篝犷洵犰镱狃痨殂狒轱ㄢ镲舡骈戾铒瞽屙痿┊ㄩ眇矧舡铒糸纟鲥蜮矬蹇ㄣ镱垠翎钿犰镱蹇戾舄ㄛ怙雉骈戾磲蝈箫祧瀛怙雉骈戾怙雉骈戾螬垠鏖箬黟锟矧铛祆螋扉怏换滹瞌躞黟骘篦轶扉怛狎殒麇蝈轭沆蹁轭轸狍换蝓瞽糸礤扉怛狎屐箦麇泔蹯漉痨殂狒泔溴铒礤礅弪篦轶璀扉怛狎骈戾钺礤螋扉怏┅┹扉怛狎箦趱篦轶璀黟锟鲥蜮矬蹇扉怃轵螬ㄤ锃泔眇殪箫躜沐骖秕麴豸骖扉怏鲩箝忪蹇篦轶璀黟锟戾舄ㄛ狃瓠篝屙疳翳蝻雉秕麴豸骖┹坩痧怙雉篝蜷铉狃疱钿狃瓠篝屙怙雉┹麒孱鲥蜮矬蹇痱轭翩㈨犭轭狃痨殂狒轱怙雉骈戾骝镯湖茴簋茴螋扉簋茴筌睥狃瓠怙雉怙雉骈戾螋扉怏箫躜沐骖┅ㄡ痧禊磲脲怙雉骈戾狃瓠怙雉Жㄡ痧孱怙雉骈戾螋扉怏扉篝秕麴豸骖┅ㄣ镳麸秕麴豸骖矬檫珏暨屮邈豸徕戾唣狒瑭┅┹垠桢忉铉扉怛狎箦趱ｆ鲥蜮矬蹇扉怃轵螬ㄤ锃泔眇殪箫躜沐骖秕麴豸骖扉怏鲩箝忪蹇ｆ戾舄ㄛ繇繇瓠骈戾钺礤秕麴豸骖┹坶镳孱骈戾秕麴豸骖线夷衔藤р轭狎轭瘐舂埏镳孱骈戾繇ǐ线滓衔藤线靡帕线列信文ｏ贩р轭狎秕麴豸┹镱屮轸ㄢ彗轭ㄣ祜箦痫螋轲ㄣ祜箦痫螋镳┅瘐舡怡翦鲥泗矧镳篝蜷铉觉翩！躞虔忾畀孱篦轶柢睥┅ㄦ矧遽汨灬礅溽螋扉猢躅戾篌ㄥ聃犰螋扉篦轶璀扉怛狎骈戾钺礤戾ㄛ轲镳孱骈戾螋扉线夷衔藤р轭狎轭瘐舂荸镱屮轸ㄣ祜箦痫螋轲ㄣ镳轲镳┅┅螋扉怏ㄣ镳轲镳┅蝈钺礤疳翳繇秕麴豸骖┅荸荸